<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>USD FX Dashboard (CNY / EUR / JPY)</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root { --border:#ddd; --muted:#666; --err:#b00020; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 16px; }
    h2 { margin: 0 0 10px 0; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom: 10px; }
    button {
      padding: 8px 10px; border-radius: 10px; border: 1px solid #ccc;
      background: #fff; cursor: pointer;
    }
    button.active { border-color:#000; font-weight: 700; }
    .muted { color: var(--muted); font-size: 12px; }
    .error { color: var(--err); margin-top: 8px; white-space: pre-wrap; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 12px; }
    .card { border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
    .pair-title { display:flex; justify-content:space-between; gap:10px; align-items:baseline; }
    .pair-title b { font-size: 16px; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: right; }
    th:first-child, td:first-child { text-align: left; }
    canvas { margin-top: 10px; }
    .topline { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .pill {
      border: 1px solid #eee; border-radius: 999px; padding: 6px 10px; font-size: 12px;
      background: #fafafa;
    }
  </style>
</head>
<body>
  <h2>USD Exchange Rates (USD → CNY / EUR / JPY)</h2>

  <div class="toolbar">
    <button class="active" data-window="1D">1D</button>
    <button data-window="1W">1W</button>
    <button data-window="1M">1M</button>
    <button data-window="1Q">1Q</button>
    <button data-window="6M">6M</button>
    <button data-window="1Y">1Y</button>
    <button data-window="5Y">5Y</button>
    <button id="btn-refresh">Refresh</button>
    <span class="muted" id="status"></span>
  </div>

  <div class="topline">
    <span class="pill" id="sourcePill">Source: —</span>
    <span class="pill" id="latestDatePill">Latest date: —</span>
    <span class="pill" id="windowPill">Window: —</span>
  </div>

  <div class="grid" style="margin-top: 12px;">
    <div class="card" id="card-CNY">
      <div class="pair-title">
        <b>USD/CNY</b>
        <span class="muted" id="latest-CNY">Latest: —</span>
      </div>
      <table>
        <thead>
          <tr>
            <th>Metric</th><th>Value</th>
          </tr>
        </thead>
        <tbody id="stats-CNY"></tbody>
      </table>
      <canvas id="chart-CNY" height="130"></canvas>
    </div>

    <div class="card" id="card-EUR">
      <div class="pair-title">
        <b>USD/EUR</b>
        <span class="muted" id="latest-EUR">Latest: —</span>
      </div>
      <table>
        <thead>
          <tr>
            <th>Metric</th><th>Value</th>
          </tr>
        </thead>
        <tbody id="stats-EUR"></tbody>
      </table>
      <canvas id="chart-EUR" height="130"></canvas>
    </div>

    <div class="card" id="card-JPY">
      <div class="pair-title">
        <b>USD/JPY</b>
        <span class="muted" id="latest-JPY">Latest: —</span>
      </div>
      <table>
        <thead>
          <tr>
            <th>Metric</th><th>Value</th>
          </tr>
        </thead>
        <tbody id="stats-JPY"></tbody>
      </table>
      <canvas id="chart-JPY" height="130"></canvas>
    </div>
  </div>

  <div class="error" id="err"></div>

<script>
(() => {
  // API fallback order
  const API_BASES = [
    "https://api.frankfurter.app",
    "https://api.frankfurter.dev"
  ];

  const BASE = "USD";
  const QUOTES = ["CNY", "EUR", "JPY"];

  // Time windows (approx days). Frankfurter is daily (business days).
  const WINDOWS = {
    "1D": 1,
    "1W": 7,
    "1M": 30,
    "1Q": 92,
    "6M": 183,
    "1Y": 365,
    "5Y": 1825
  };

  const el = (id) => document.getElementById(id);
  const statusEl = el("status");
  const errEl = el("err");
  const sourcePill = el("sourcePill");
  const latestDatePill = el("latestDatePill");
  const windowPill = el("windowPill");

  let currentWindowKey = "1D";
  let currentApiBase = null;

  const charts = { CNY: null, EUR: null, JPY: null };

  function pad2(n) { return String(n).padStart(2, "0"); }
  function yyyy_mm_dd(d) {
    return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
  }
  function dateNDaysAgo(days) {
    const d = new Date();
    d.setDate(d.getDate() - days);
    return d;
  }

  function fmt(x, digits) {
    if (x === null || x === undefined || Number.isNaN(x)) return "—";
    return Number(x).toFixed(digits);
  }
  function fmtRate(quote, x) {
    // Just formatting preference
    const digits = (quote === "JPY") ? 4 : 6;
    return fmt(x, digits);
  }
  function fmtPct(x) {
    if (x === null || x === undefined || Number.isNaN(x)) return "—";
    return (Number(x) * 100).toFixed(2) + "%";
  }

  async function fetchWithFallback(pathAndQuery) {
    let lastErr = null;
    for (const base of API_BASES) {
      const url = base + pathAndQuery;
      try {
        const resp = await fetch(url, { cache: "no-store" });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${url}`);
        const data = await resp.json();
        currentApiBase = base;
        return data;
      } catch (e) {
        lastErr = e;
      }
    }
    throw lastErr || new Error("All API endpoints failed.");
  }

  function setActiveButton(windowKey) {
    document.querySelectorAll("button[data-window]").forEach(btn => {
      btn.classList.toggle("active", btn.dataset.window === windowKey);
    });
  }

  function clearError() { errEl.textContent = ""; }
  function setError(msg) { errEl.textContent = msg; }

  function computeStats(timeseries, quote) {
    // timeseries: { rates: { "YYYY-MM-DD": {CNY:...,EUR:...,JPY:...}, ... } }
    const dates = Object.keys(timeseries.rates || {}).sort();
    if (dates.length === 0) return null;

    const values = dates
      .map(dt => timeseries.rates[dt]?.[quote])
      .filter(v => v !== undefined && v !== null && !Number.isNaN(v));

    if (values.length === 0) return null;

    const firstDate = dates[0];
    const lastDate = dates[dates.length - 1];

    const start = timeseries.rates[firstDate]?.[quote];
    const end = timeseries.rates[lastDate]?.[quote];

    const high = Math.max(...values);
    const low = Math.min(...values);
    const amplitude = high - low;

    const change = (end - start) / start;
    const amplitudePct = amplitude / start;

    return {
      firstDate, lastDate,
      start, end,
      change,
      high, low,
      amplitude,
      amplitudePct,
      dates
    };
  }

  function renderStatsTable(quote, stats) {
    const tbody = el(`stats-${quote}`);
    tbody.innerHTML = "";

    if (!stats) {
      tbody.innerHTML = `<tr><td colspan="2">No data</td></tr>`;
      return;
    }

    const rows = [
      ["Start date", stats.firstDate],
      ["End date", stats.lastDate],
      ["Start", fmtRate(quote, stats.start)],
      ["End", fmtRate(quote, stats.end)],
      ["Change", fmtPct(stats.change)],
      ["High", fmtRate(quote, stats.high)],
      ["Low", fmtRate(quote, stats.low)],
      ["Amplitude (High−Low)", fmtRate(quote, stats.amplitude)],
      ["Amplitude / Start", fmtPct(stats.amplitudePct)]
    ];

    for (const [k, v] of rows) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${k}</td><td>${v}</td>`;
      tbody.appendChild(tr);
    }
  }

  function renderLatest(latest) {
    // latest: { base, date, rates: {CNY,EUR,JPY} }
    latestDatePill.textContent = `Latest date: ${latest.date}`;

    for (const q of QUOTES) {
      const rate = latest.rates?.[q];
      el(`latest-${q}`).textContent = `Latest: ${fmtRate(q, rate)} (as of ${latest.date})`;
    }
  }

  function renderChart(quote, timeseries, stats) {
    const canvasId = `chart-${quote}`;
    const ctx = el(canvasId).getContext("2d");

    if (charts[quote]) charts[quote].destroy();

    if (!stats) {
      charts[quote] = new Chart(ctx, {
        type: "line",
        data: { labels: [], datasets: [] },
        options: { responsive: true }
      });
      return;
    }

    const labels = stats.dates;
    const data = labels.map(dt => timeseries.rates[dt]?.[quote]);

    charts[quote] = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: `${BASE}/${quote}`,
          data,
          spanGaps: true
        }]
      },
      options: {
        responsive: true,
        interaction: { mode: "index", intersect: false },
        plugins: { legend: { display: true } },
        scales: {
          x: { ticks: { maxTicksLimit: 8 } }
        }
      }
    });
  }

  async function loadAll(windowKey) {
    clearError();
    statusEl.textContent = "Loading…";

    const days = WINDOWS[windowKey];
    if (!days) {
      setError(`Unknown window: ${windowKey}`);
      statusEl.textContent = "";
      return;
    }

    const toList = QUOTES.join(",");
    const start = yyyy_mm_dd(dateNDaysAgo(days));
    const end = yyyy_mm_dd(new Date());

    // Paths
    const latestPath = `/latest?from=${encodeURIComponent(BASE)}&to=${encodeURIComponent(toList)}`;
    const rangePath  = `/${start}..${end}?from=${encodeURIComponent(BASE)}&to=${encodeURIComponent(toList)}`;

    try {
      const [latest, ts] = await Promise.all([
        fetchWithFallback(latestPath),
        fetchWithFallback(rangePath)
      ]);

      sourcePill.textContent = `Source: ${currentApiBase.replace("https://", "")}`;
      windowPill.textContent = `Window: ${windowKey} (${start} → ${end})`;

      renderLatest(latest);

      for (const q of QUOTES) {
        const stats = computeStats(ts, q);
        renderStatsTable(q, stats);
        renderChart(q, ts, stats);
      }

      statusEl.textContent = `Updated: ${new Date().toLocaleString()}`;
    } catch (e) {
      setError(
        `Failed to load data.\n` +
        `Tried: ${API_BASES.join(" , ")}\n` +
        `Error: ${e.message}\n\n` +
        `Tip: Frankfurter provides daily (usually business-day) reference rates; 1D may contain only a small number of points.`
      );
      statusEl.textContent = "";
      sourcePill.textContent = "Source: —";
      latestDatePill.textContent = "Latest date: —";
      windowPill.textContent = "Window: —";
    }
  }

  // Button wiring
  document.querySelectorAll("button[data-window]").forEach(btn => {
    btn.addEventListener("click", () => {
      currentWindowKey = btn.dataset.window;
      setActiveButton(currentWindowKey);
      loadAll(currentWindowKey);
    });
  });

  el("btn-refresh").addEventListener("click", () => loadAll(currentWindowKey));

  // Initial load
  setActiveButton(currentWindowKey);
  loadAll(currentWindowKey);
})();
</script>
</body>
</html>
