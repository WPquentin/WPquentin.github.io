<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Trifold Brochure</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f0f0f0; }
    #file-input { margin-bottom: 1em; }
    #status { margin-bottom: 1em; color: #333; }
    #brochure {
      display: flex;
      overflow-x: auto;
      align-items: center;
      height: 80vh;
    }
    .panel {
      flex: none;
      margin: 0 5px;
      cursor: pointer;
      transition: transform 0.5s;
      position: relative;
    }
    .panel img {
      display: block;
      max-height: 100%;
      height: auto;
      width: auto;
    }
  </style>
</head>
<body>
  <input type="file" id="file-input" accept="application/pdf" />
  <div id="status">请选择一个两页 PDF。</div>
  <div id="brochure"></div>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    // 面板映射：编号->[页码, 切片索引]
    const mapping = {1:[1,2], 2:[2,0], 3:[1,0], 4:[2,1], 5:[2,2], 6:[1,1]};
    // 七个状态下要显示的面板序列
    const states = [[1],[2,3],[2,4,5],[3,6,1],[6,1],[6],[1]];
    let panelImages = {}, state = 0;

    document.getElementById('file-input').addEventListener('change', async e => {
      const file = e.target.files[0];
      if (!file) return;
      document.getElementById('status').textContent = '载入 PDF…';
      const array = await file.arrayBuffer();
      const data = new Uint8Array(array);
      const pdf = await pdfjsLib.getDocument({ data }).promise;
      if (pdf.numPages < 2) {
        document.getElementById('status').textContent = 'PDF 必须至少包含两页。';
        return;
      }
      document.getElementById('status').textContent = '渲染所有面板…';
      // 预渲染 1-6 面板
      for (const num of Object.keys(mapping)) {
        const [pg, idx] = mapping[num];
        const page = await pdf.getPage(pg);
        const viewport = page.getViewport({ scale: 1.5 });
        const tmp = document.createElement('canvas');
        tmp.width = viewport.width;
        tmp.height = viewport.height;
        await page.render({ canvasContext: tmp.getContext('2d'), viewport }).promise;

        const panelWidth = Math.floor(viewport.width / 3);
        const panelHeight = viewport.height;
        const slice = document.createElement('canvas');
        slice.width = panelWidth;
        slice.height = panelHeight;
        slice.getContext('2d').drawImage(
          tmp,
          idx * panelWidth, 0,
          panelWidth, panelHeight,
          0, 0,
          panelWidth, panelHeight
        );
        panelImages[num] = slice.toDataURL();
      }
      state = 0;
      showState();
      document.getElementById('status').textContent = '点击封面（1），按照提示进行交互。';
    });

    function showState() {
      const container = document.getElementById('brochure');
      container.innerHTML = '';
      states[state].forEach(num => {
        const div = document.createElement('div');
        div.className = 'panel';
        div.dataset.index = num;
        const img = document.createElement('img');
        img.src = panelImages[num];
        div.appendChild(img);
        container.appendChild(div);
      });
    }

    document.getElementById('brochure').addEventListener('click', e => {
      const panel = e.target.closest('.panel');
      if (!panel) return;
      const idx = panel.dataset.index;
      // 各状态的触发规则
      if ((state === 0 && idx === '1') ||
          (state === 1 && idx === '3') ||
          (state === 2) ||
          (state === 3 && idx === '3') ||
          (state === 4 && idx === '1') ||
          (state === 5)) {
        nextState();
      }
    });

    function nextState() {
      state = (state + 1) % states.length;
      showState();
      const hints = [
        '封面 1',
        '打开 1 → 显示 2,3',
        '打开 3 → 显示 2,4,5',
        '旋转 → 显示 3,6,1',
        '折叠 3 → 显示 6,1',
        '折叠 1 → 显示 6',
        '旋转回初始 → 显示 1'
      ];
      document.getElementById('status').textContent = hints[state];
    }
  </script>
</body>
</html>
