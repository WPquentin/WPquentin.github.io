<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Trifold Brochure</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; }
    #file-input { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 10; }
    #status {
      position: absolute;
      top: 50px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.9);
      padding: 5px 10px;
      border-radius: 4px;
      font-family: sans-serif;
      z-index: 10;
    }
    #brochure-wrapper {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: transparent;
    }
    #brochure {
      display: flex;
      width: 100%;
      height: 100%;
    }
    .panel {
      flex: none;
      cursor: pointer;
      transition: transform 0.5s;
      position: relative;
      overflow: hidden;
      background: #fff;
    }
    .panel.empty { background: transparent; cursor: default; }
    .panel img {
      display: block;
      width: auto;
      height: 100%;
    }
  </style>
</head>
<body>
  <input type="file" id="file-input" accept="application/pdf" />
  <div id="status">请选择一个两页 PDF。</div>
  <div id="brochure-wrapper">
    <div id="brochure"></div>
  </div>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    const mapping = {1:[1,2], 2:[2,0], 3:[1,0], 4:[2,1], 5:[2,2], 6:[1,1]};
    const states = [
      [0,1,0], // 封面
      [2,3,0],
      [2,4,5],
      [3,6,1],
      [0,6,1],
      [0,6,0],
      [0,1,0]
    ];
    let panelImages = {}, state = 0;
    let panelWidth, panelHeight;

    const input = document.getElementById('file-input');
    const status = document.getElementById('status');
    const wrapper = document.getElementById('brochure-wrapper');
    const brochure = document.getElementById('brochure');

    input.addEventListener('change', async () => {
      status.textContent = '载入 PDF…';
      const file = input.files[0]; if (!file) return;
      const array = new Uint8Array(await file.arrayBuffer());
      const pdf = await pdfjsLib.getDocument({ data: array }).promise;
      if (pdf.numPages < 2) { status.textContent = 'PDF 必须至少包含两页。'; return; }
      status.textContent = '渲染所有面板…';

      // 预渲染并记录 panelWidth, panelHeight
      for (const num of Object.keys(mapping)) {
        const [pg, idx] = mapping[num];
        const page = await pdf.getPage(pg);
        const viewport = page.getViewport({ scale: 1.5 });
        panelWidth  = Math.floor(viewport.width / 3);
        panelHeight = viewport.height;
        const tmp = document.createElement('canvas');
        tmp.width = viewport.width;
        tmp.height = viewport.height;
        await page.render({ canvasContext: tmp.getContext('2d'), viewport }).promise;

        const slice = document.createElement('canvas');
        slice.width = panelWidth;
        slice.height = panelHeight;
        slice.getContext('2d').drawImage(
          tmp,
          idx * panelWidth, 0,
          panelWidth, panelHeight,
          0, 0,
          panelWidth, panelHeight
        );
        panelImages[num] = slice.toDataURL();
      }

      // 固定 wrapper 大小并居中
      wrapper.style.width  = (panelWidth * 3 + 20) + 'px';
      wrapper.style.height = panelHeight + 'px';
      state = 0;
      showState();
      status.textContent = '点击封面开始';
    });

    function showState() {
      brochure.innerHTML = '';
      states[state].forEach((num, i) => {
        const div = document.createElement('div');
        div.className = 'panel' + (num==0?' empty':'');
        div.style.width  = panelWidth + 'px';
        div.style.height = panelHeight + 'px';
        if (num) {
          const img = document.createElement('img');
          img.src = panelImages[num];
          div.appendChild(img);
        }
        div.dataset.index = num;
        brochure.appendChild(div);
      });
    }

    wrapper.addEventListener('click', e => {
      const div = e.target.closest('.panel'); if (!div) return;
      const idx = div.dataset.index;
      const valid = (state===0&&idx==='1') ||
                    (state===1&&idx==='3') ||
                    (state===2) ||
                    (state===3&&idx==='3')||
                    (state===4&&idx==='1') ||
                    (state===5);
      if (valid) nextState();
    });

    function nextState() {
      state = (state + 1) % states.length;
      showState();
      const hints = ['封面','打开 1','打开 3','旋转','折叠 3','折叠 1','回到封面'];
      status.textContent = hints[state];
    }
  </script>
</body>
</html>
