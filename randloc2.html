<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Japan Land Sampler</title>
  <style>
    :root { color-scheme: light dark; }
    body {
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;
      margin: 0; min-height: 100vh; display: grid; place-items: center; padding: 24px;
      background-color: canvas; color: canvastext; overflow-x: hidden;
    }
    .card { width: min(820px, 100%); border: 1px solid rgba(127,127,127,.25); border-radius: 16px; padding: 40px; box-shadow: 0 4px 24px rgba(0,0,0,0.05); position: relative; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
    h1 { margin: 0; font-size: 14px; text-transform: uppercase; letter-spacing: 0.2em; opacity: 0.5; font-weight: 700; }
    #menuBtn { background: none; border: 1px solid rgba(127,127,127,0.3); color: inherit; padding: 6px 16px; border-radius: 20px; font-size: 13px; cursor: pointer; }
    .section { margin-bottom: 32px; cursor: pointer; }
    .label { font-size: 12px; font-weight: 700; opacity: 0.4; margin-bottom: 8px; text-transform: uppercase; }
    .value { font-size: clamp(40px, 7vw, 76px); font-weight: 900; line-height: 1.05; letter-spacing: -0.02em; }
    .sub-value { font-size: clamp(16px, 3vw, 20px); font-weight: 400; opacity: 0.7; margin-top: 10px; }
    button#btn { width: 100%; background: canvastext; color: canvas; border: none; padding: 22px; border-radius: 14px; font-size: 18px; font-weight: 700; cursor: pointer; }
    button:disabled { opacity: 0.3; }
    #menu { position: fixed; top: 0; right: 0; width: min(420px, 100%); height: 100%; background: canvas; border-left: 1px solid rgba(127,127,127,0.2); z-index: 100; padding: 32px; display: none; overflow-y: auto; }
    .menu-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .pref-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px; }
    .pref-item { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .coords-footer { font-family: ui-monospace, monospace; font-size: 13px; opacity: 0.4; margin-top: 40px; border-top: 1px solid rgba(127,127,127,0.15); padding-top: 20px; display: flex; justify-content: space-between; }
    .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 24px; font-size: 13px; display: none; z-index: 200; }
  </style>
</head>
<body>

  <div class="card">
    <div class="top-bar">
        <h1>Japan Land Sampler</h1>
        <button id="menuBtn">Filters / 表示設定</button>
    </div>
    <div id="main-content">Loading...</div>
    <button id="btn" disabled>PLEASE WAIT</button>
    <div id="footer" class="coords-footer" style="visibility:hidden;"><span id="latlon" style="cursor:pointer">...</span><span>PRESS 'R' TO ROLL</span></div>
  </div>

  <div id="menu">
    <div class="menu-header"><b>Filters / 抽出設定</b><a href="#" id="closeMenu" style="text-decoration:none; color:inherit; font-size:28px;">&times;</a></div>
    <p class="label">Islands / 主要な島</p>
    <div class="pref-grid" style="margin-bottom: 24px; background: rgba(127,127,127,0.05); padding: 12px; border-radius: 8px;">
        <label class="pref-item"><input type="checkbox" class="island-toggle" value="Honshu" checked> 本州</label>
        <label class="pref-item"><input type="checkbox" class="island-toggle" value="Hokkaido" checked> 北海道</label>
        <label class="pref-item"><input type="checkbox" class="island-toggle" value="Kyushu" checked> 九州</label>
        <label class="pref-item"><input type="checkbox" class="island-toggle" value="Shikoku" checked> 四国</label>
        <label class="pref-item"><input type="checkbox" class="island-toggle" value="Okinawa" checked> 沖縄</label>
    </div>
    <p class="label">Prefectures / 都道府県</p>
    <div id="prefList" class="pref-grid"></div>
  </div>

  <div id="toast" class="toast">Copied</div>

  <script>
    let allTriangles = [], cityData = [], activeTriangles = [], totalArea = 0;
    const islandMap = {
        "Hokkaido": ["北海道"],
        "Honshu": ["青森県","岩手県","宮城県","秋田県","山形県","福島県","茨城県","栃木県","群马県","埼玉県","千葉県","東京都","神奈川県","新潟県","富山県","石川県","福井県","山梨県","長野県","岐阜県","静岡県","爱知県","三重県","滋賀県","京都府","大阪府","兵庫県","奈良県","和歌山県","鳥取県","島根県","岡山県","広島県","山口県"],
        "Shikoku": ["徳島県","香川県","愛媛県","高知県"],
        "Kyushu": ["福岡県","佐賀県","長崎県","熊本県","大分県","宮崎県","鹿児島県"],
        "Okinawa": ["沖縄県"]
    };

    async function init() {
      try {
        const [r1, r2] = await Promise.all([fetch('japan_data_optimized.json'), fetch('municipalities.json')]);
        allTriangles = await r1.json();
        cityData = await r2.json();
        cityData.forEach(c => { c.latN = parseFloat(c.lat); c.lonN = parseFloat(c.lon); });

        const prefs = [...new Set(cityData.map(c => c.prefecture_kanji))];
        document.getElementById('prefList').innerHTML = prefs.map(p => `<label class="pref-item"><input type="checkbox" class="p-toggle" value="${p}" checked> ${p}</label>`).join('');

        setupInteractions();
        updateAndRoll();
        document.getElementById('btn').disabled = false;
        document.getElementById('btn').textContent = "SAMPLE RANDOM LOCATION";
      } catch (e) { document.getElementById('main-content').innerText = "Error loading optimized data."; }
    }

    function setupInteractions() {
        document.querySelectorAll('.island-toggle').forEach(ib => {
            ib.onchange = () => { islandMap[ib.value].forEach(pn => { const pb = document.querySelector(`.p-toggle[value="${pn}"]`); if(pb) pb.checked = ib.checked; }); };
        });
        document.getElementById('closeMenu').onclick = (e) => { e.preventDefault(); document.getElementById('menu').style.display='none'; updateAndRoll(); };
        document.getElementById('menuBtn').onclick = () => document.getElementById('menu').style.display='block';
        document.getElementById('btn').onclick = roll;
        window.onkeydown = (e) => { if(e.key.toLowerCase()==='r' || e.code==='Space') roll(); };
    }

    function updateAndRoll() {
        const activePrefs = new Set([...document.querySelectorAll('.p-toggle:checked')].map(i => i.value));
        activeTriangles = allTriangles.filter(t => activePrefs.has(t.f));
        totalArea = activeTriangles.reduce((s, t) => s + t.a, 0);
        roll();
    }

    function roll() {
      if (totalArea === 0) return;
      let r = Math.random() * totalArea, tri = activeTriangles[0];
      for (const t of activeTriangles) { r -= t.a; if (r <= 0) { tri = t; break; } }
      
      const r1 = Math.sqrt(Math.random()), r2 = Math.random();
      const pt = {
        lon: (1 - r1) * tri.p[0][0] + (r1 * (1 - r2)) * tri.p[1][0] + (r1 * r2) * tri.p[2][0],
        lat: (1 - r1) * tri.p[0][1] + (r1 * (1 - r2)) * tri.p[1][1] + (r1 * r2) * tri.p[2][1]
      };

      let nC = null, dC = Infinity, nT = null, dT = Infinity;
      cityData.forEach(c => {
        let d = Math.pow(c.latN - pt.lat, 2) + Math.pow(c.lonN - pt.lon, 2);
        if (c.prefecture_kanji !== tri.f) d *= 1000;
        if (c.name_romaji.endsWith("Shi") || c.name_romaji.endsWith("Ku")) { if(d < dC){ dC = d; nC = c; } }
        else { if(d < dT){ dT = d; nT = c; } }
      });

      document.getElementById('main-content').innerHTML = `
        <div class="section" onclick="copy('${nC.name_kanji}')"><div class="label">Nearest City</div><div class="value">${nC.name_kanji}</div><div class="sub-value">${nC.name_romaji}, ${nC.prefecture_romaji}</div></div>
        <div class="section" onclick="copy('${nT.name_kanji}')"><div class="label">Nearest Municipality</div><div class="value">${nT.name_kanji}</div><div class="sub-value">${nT.name_romaji}, ${nT.prefecture_romaji}</div></div>
      `;
      document.getElementById('footer').style.visibility = "visible";
      const cStr = `${pt.lat.toFixed(6)}, ${pt.lon.toFixed(6)}`;
      document.getElementById('latlon').innerText = cStr;
      document.getElementById('latlon').onclick = () => copy(cStr);
    }

    function copy(t) { navigator.clipboard.writeText(t); const ts = document.getElementById('toast'); ts.style.display='block'; setTimeout(()=>ts.style.display='none',2000); }

    init();
  </script>
</body>
</html>
