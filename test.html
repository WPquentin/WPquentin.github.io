<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>弹幕分析 test</title>
  <style>
    /* Hidden class for filtering */
    .hidden { display: none; }
    /* Bullet list styles */
    #bulletList { margin: 0; padding: 0; }
    #bulletList li { list-style: none; padding: 2px 4px; cursor: pointer; }
    /* Search status text */
    #searchStatus { margin-top: 5px; font-style: italic; color: #555; }
    /* Optional: style the density chart and color bar (e.g., add borders if needed) */
    #densityChart { display: block; margin-top: 10px; }
    #colorBar { margin-left: 5px; }
  </style>
</head>
<body>

<div class="controls">
  <button id="toggleStream">开启流式</button>
  速度: <input type="range" id="speedSlider" min="100" max="1000" value="100">
  <span id="speedVal">1000 ms/条</span>
  <br>
  搜索: <input type="text" id="searchInput" placeholder="输入关键词">
  <button id="searchBtn">搜索</button>
  模式:
  <label><input type="radio" name="searchMode" value="AND"> 且</label>
  <label><input type="radio" name="searchMode" value="OR" checked> 或</label>
  <button id="resetBtn">重置搜索</button>
  <button id="backBtn" style="display:none;">回到搜索</button>
  <button id="wordCloudBtn">词频云</button>
</div>

<div id="searchStatus"></div>

<canvas id="densityChart" width="600" height="100"></canvas>

<div id="listArea" style="display:flex; align-items: stretch; margin-top:5px;">
  <div id="bulletContainer" style="flex:1 1 auto; height:400px; overflow-y:auto;">
    <ul id="bulletList">
      <!-- 弹幕列表内容，由脚本生成 -->
    </ul>
  </div>
  <canvas id="colorBar" width="10" height="400"></canvas>
</div>

<!-- 词频云弹出层 -->
<div id="wordCloudOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
     background: rgba(0,0,0,0.5);">
  <div id="wordCloudContainer" style="position:relative; width:80%; height:80%; margin:5% auto; background:#fff; overflow:hidden;">
    <!-- 单词云内容 -->
    <!-- 复制提示 -->
    <div id="copyMsg" style="position:fixed; top:20px; width:100%; text-align:center; font-size:18px;
         color:green; display:none;">词已复制</div>
  </div>
</div>

<script>
  // 弹幕数据示例 (time: 秒, text: 弹幕内容)
  var bullets = [
    { time: 1, text: "哈哈" },
    { time: 2, text: "Test bullet here" },
    { time: 2.5, text: "Hello world" },
    { time: 3, text: "哈哈" },
    { time: 10, text: "Test bullet here" },
    { time: 10.2, text: "你好世界" },
    { time: 11, text: "just a test bullet" },
    { time: 11.5, text: "another test" },
    { time: 12, text: "foo bar test" },
    { time: 13, text: "haha test" },
    { time: 13.5, text: "的 的 的 test" }
  ];

  // 全局变量初始化
  var bulletElems = [];
  var currentIndex = 0, currentDisplayed = -1;
  var isStreaming = false;
  var streamTimer = null, resumeTimer = null;
  var userScrolling = false;
  var searchActive = false;
  var searchQuery = "", searchMode = "OR";
  var searchDensity = []; // 存储搜索匹配弹幕的密度
  var wordCloudGenerated = false;

  // 创建弹幕列表项
  var bulletList = document.getElementById('bulletList');
  // 按时间排序弹幕
  bullets.sort((a, b) => a.time - b.time);
  bullets.forEach((b, i) => {
    var li = document.createElement('li');
    li.textContent = b.text;
    bulletList.appendChild(li);
    bulletElems.push(li);
    // 点击弹幕（暂停状态下选择弹幕继续播放）
    li.addEventListener('click', function() {
      if (!isStreaming && searchActive === false) {
        // 未流式播放时，点击可选中弹幕作为起始
        currentIndex = i;
        bulletElems[i].scrollIntoView({ block: "center" });
      } else if (searchActive) {
        // 搜索模式下点击搜索结果
        bulletElems.forEach(elem => { elem.style.display = ''; }); // 显示所有弹幕
        this.scrollIntoView({ block: "center" });
        document.getElementById('backBtn').style.display = 'inline';
        // 保持searchActive为true以便“回到搜索”按钮可用
      }
    });
  });

  // 计算弹幕密度数据
  var totalTime = 0;
  if (bullets.length > 0) {
    totalTime = Math.ceil(bullets[bullets.length - 1].time);
  }
  var density = new Array(totalTime + 1).fill(0);
  bullets.forEach(b => {
    var sec = Math.floor(b.time);
    if (sec <= totalTime) density[sec]++;
  });
  var maxDensity = Math.max(...density, 0);

  // 绘制弹幕密度折线图 (X轴: 时间, Y轴: 弹幕数)
  function drawChart(highlightSearch) {
    var canvas = document.getElementById('densityChart');
    // 调整画布宽度为弹幕容器宽度
    canvas.width = document.getElementById('bulletContainer').clientWidth;
    var ctx = canvas.getContext('2d');
    var w = canvas.width, h = canvas.height;
    ctx.clearRect(0, 0, w, h);
    // 坐标轴
    ctx.strokeStyle = "#000";
    ctx.beginPath();
    ctx.moveTo(0, h - 0.5); ctx.lineTo(w, h - 0.5);  // X轴 (底部)
    ctx.moveTo(0.5, 0); ctx.lineTo(0.5, h);         // Y轴 (左侧)
    ctx.stroke();
    // 绘制原始弹幕密度折线
    ctx.beginPath();
    for (let t = 0; t <= totalTime; t++) {
      let x = (t / totalTime) * w;
      // 弹幕数 -> 垂直高度 (越多弹幕，线越低)
      let y = (maxDensity > 0) ? (h - (density[t] / maxDensity) * h) : h;
      if (t === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    if (highlightSearch) {
      // 模糊原密度线：使用虚线和浅色显示
      ctx.strokeStyle = "#aaa";
      ctx.setLineDash([4, 2]);
    } else {
      ctx.strokeStyle = "#888";
      ctx.setLineDash([]);
    }
    ctx.stroke();
    ctx.setLineDash([]); // 重置虚线设置
    // 绘制搜索匹配弹幕密度折线（如果有）
    if (highlightSearch && searchDensity.length) {
      let maxSearch = Math.max(...searchDensity, 0);
      ctx.beginPath();
      for (let t = 0; t <= totalTime; t++) {
        let x = (t / totalTime) * w;
        let y = (maxSearch > 0) ? (h - (searchDensity[t] / maxSearch) * h) : h;
        if (t === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.strokeStyle = "#00f";
      ctx.stroke();
    }
    // X轴时间刻度标注（起始和结束）
    ctx.fillStyle = "#000";
    ctx.textAlign = "left";
    ctx.fillText("0s", 2, h - 2);
    ctx.textAlign = "right";
    if (totalTime >= 0) {
      let endLabel = formatTime(totalTime);
      ctx.fillText(endLabel, w - 2, h - 2);
    }
  }

  // 绘制右侧弹幕密度颜色条
  function drawColorBar(highlightSearch) {
    var barCanvas = document.getElementById('colorBar');
    // 调整高度与弹幕容器相同
    barCanvas.height = document.getElementById('bulletContainer').clientHeight;
    var barCtx = barCanvas.getContext('2d');
    var bw = barCanvas.width, bh = barCanvas.height;
    // 清空画布
    barCtx.clearRect(0, 0, bw, bh);
    // 遍历时间片段绘制颜色
    let maxSearch = highlightSearch ? Math.max(...searchDensity, 0) : 0;
    for (let sec = 0; sec < density.length; sec++) {
      let y0 = Math.floor((sec / totalTime) * bh);
      let y1 = Math.floor(((sec + 1) / totalTime) * bh);
      if (y1 < y0) y1 = y0 + 1;
      // 计算底色（原始弹幕密度）和高亮色（搜索密度）
      let baseRatio = (maxDensity > 0) ? (density[sec] / maxDensity) : 0;
      // 原密度颜色: 白->红 渐变 (密度越高越红)
      let baseR = 255;
      let baseG = 255 - Math.floor(255 * baseRatio);
      let baseB = 255 - Math.floor(255 * baseRatio);
      if (highlightSearch) {
        // 搜索模式下底色改为灰度
        baseG = baseB = 255 - Math.floor(180 * baseRatio);
        baseR = baseG;
      }
      let baseColor = `rgb(${baseR},${baseG},${baseB})`;
      // 默认使用底色
      let fillColor = baseColor;
      if (highlightSearch && maxSearch > 0 && searchDensity[sec] > 0) {
        // 高亮搜索密度: 白->蓝 渐变 (密度越高越蓝)
        let searchRatio = searchDensity[sec] / maxSearch;
        let highR = 255 - Math.floor(255 * searchRatio);
        let highG = 255 - Math.floor(255 * searchRatio);
        let highB = 255;
        fillColor = `rgb(${highR},${highG},${highB})`;
      }
      barCtx.fillStyle = fillColor;
      barCtx.fillRect(0, y0, bw, Math.max(1, y1 - y0));  // 确保至少1px高
    }
  }

  // 时间格式化（秒 -> mm:ss 或 h:mm:ss）
  function formatTime(sec) {
    let m = Math.floor(sec / 60);
    let s = sec % 60;
    if (m < 60) {
      return m + ":" + (s < 10 ? "0" + s : s);
    } else {
      let h = Math.floor(m / 60);
      m = m % 60;
      return h + ":" + (m < 10 ? "0" + m : m) + ":" + (s < 10 ? "0" + s : s);
    }
  }

  // 执行搜索
  function performSearch() {
    var input = document.getElementById('searchInput');
    searchQuery = input.value.trim();
    if (searchQuery === "") {
      resetSearch();
      return;
    }
    // 关闭流式播放（如果正在播放）再搜索
    if (isStreaming) {
      stopStreaming();
    }
    // 显示所有弹幕再筛选
    bulletElems.forEach(elem => { elem.style.display = ''; });
    // 获取关键词列表和模式
    let keywords = searchQuery.split(/\s+/).filter(w => w !== "");
    let mode = document.querySelector('input[name="searchMode"]:checked').value;
    searchMode = mode;
    // 统计匹配结果
    let matchCount = 0;
    // 重置搜索密度计数
    searchDensity = new Array(totalTime + 1).fill(0);
    // 过滤弹幕显示
    bulletElems.forEach((elem, index) => {
      let text = elem.textContent;
      let matched = false;
      if (mode === "AND") {
        // 所有关键词都需出现
        matched = keywords.every(kw => text.includes(kw));
      } else {
        // 任一关键词出现即可
        matched = keywords.some(kw => text.includes(kw));
      }
      if (matched) {
        matchCount++;
        // 记录匹配弹幕时间到搜索密度
        let sec = Math.floor(bullets[index].time);
        if (sec <= totalTime) searchDensity[sec]++;
      } else {
        elem.style.display = 'none';
      }
    });
    // 更新搜索状态UI
    let statusText = "当前搜索: " + keywords.join(mode === "AND" ? " 且 " : " 或 ");
    statusText += " （" + matchCount + " 条结果）";
    document.getElementById('searchStatus').textContent = statusText;
    // 隐藏“回到搜索”按钮（新搜索时重置状态）
    document.getElementById('backBtn').style.display = 'none';
    // 设置搜索激活标志
    searchActive = true;
    // 更新折线图和密度条显示（高亮搜索密度）
    drawChart(true);
    drawColorBar(true);
    // 若有匹配结果，自动滚动到第一个匹配弹幕的位置
    if (matchCount > 0) {
      // 滚动到第一个可见的匹配弹幕
      for (let elem of bulletElems) {
        if (elem.style.display !== 'none') {
          elem.scrollIntoView({ block: "center" });
          break;
        }
      }
    }
  }

  // 重置搜索
  function resetSearch() {
    // 显示所有弹幕
    bulletElems.forEach(elem => { elem.style.display = ''; });
    // 清除搜索状态UI
    document.getElementById('searchStatus').textContent = "";
    document.getElementById('backBtn').style.display = 'none';
    document.getElementById('searchInput').value = "";
    // 取消搜索模式
    searchActive = false;
    searchQuery = "";
    searchDensity = [];
    // 恢复原始折线图和密度条
    drawChart(false);
    drawColorBar(false);
  }

  // 开始流式播放
  function startStreaming() {
    if (bullets.length === 0) return;
    // 如有搜索筛选，重置以播放全部弹幕
    if (searchActive) {
      resetSearch();
    }
    isStreaming = true;
    // 调整按钮文字
    document.getElementById('toggleStream').textContent = "关闭流式";
    // 如果当前索引超出范围，从头开始
    if (currentIndex < 0 || currentIndex >= bulletElems.length) {
      currentIndex = 0;
    }
    // 开始播放
    streamNext();
  }

  // 停止/暂停流式播放
  function stopStreaming() {
    isStreaming = false;
    clearTimeout(streamTimer);
    clearTimeout(resumeTimer);
    document.getElementById('toggleStream').textContent = "开启流式";
  }

  // 流式播放下一个弹幕
  function streamNext() {
    if (!isStreaming || currentIndex >= bulletElems.length) {
      // 播放结束
      stopStreaming();
      return;
    }
    currentDisplayed = currentIndex;
    // 滚动当前弹幕至容器中部&#8203;:contentReference[oaicite:0]{index=0}
    if (!userScrolling) {
      bulletElems[currentIndex].scrollIntoView({ block: "center" });
    }
    currentIndex++;
    // 设置下一条弹幕定时
    if (currentIndex < bulletElems.length) {
      streamTimer = setTimeout(streamNext, currentSpeed);
    } else {
      // 已播放到最后一条
      stopStreaming();
    }
  }

  // 剪贴板复制函数&#8203;:contentReference[oaicite:1]{index=1}&#8203;:contentReference[oaicite:2]{index=2}
  function copyToClipboard(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(() => {
        showCopyMsg();
      }).catch(err => {
        fallbackCopy(text);
      });
    } else {
      fallbackCopy(text);
    }
  }
  function fallbackCopy(text) {
    var textArea = document.createElement('textarea');
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    try {
      document.execCommand('copy');
      showCopyMsg();
    } catch (e) {
      console.error('Copy failed', e);
    }
    document.body.removeChild(textArea);
  }
  function showCopyMsg() {
    var msg = document.getElementById('copyMsg');
    if (!msg) return;
    msg.style.display = 'block';
    setTimeout(() => { msg.style.display = 'none'; }, 1000);
  }

  // 生成词频云
  function generateWordCloud() {
    // 构建停用词集合，过滤无意义词语
    var stopWords = new Set([
      "the","and","to","of","a","an","is","in","it","that","this","so","for","on","with","as","are","was","if","not","i","me","you",
      "的","了","和","是","我","也","就","不","有","吗","啊","吧","在","还","很"
    ]);
    var freqMap = {};
    bullets.forEach(b => {
      // 提取每条弹幕的词语
      let text = b.text.toLowerCase();
      // 用非字母/数字/汉字字符分隔
      let tokens = text.split(/[^A-Za-z0-9\u4e00-\u9fff]+/).filter(t => t);
      tokens.forEach(token => {
        if (stopWords.has(token)) return;
        if (!freqMap[token]) freqMap[token] = 0;
        freqMap[token]++;
      });
    });
    var freqList = Object.entries(freqMap);
    if (freqList.length === 0) return;
    // 按频次数从高到低排序
    freqList.sort((a, b) => b[1] - a[1]);
    // 取前100个高频词
    var maxWords = 100;
    if (freqList.length > maxWords) {
      freqList = freqList.slice(0, maxWords);
    }
    var maxFreq = freqList[0][1];
    var minFreq = freqList[freqList.length - 1][1];
    var minFont = 14, maxFont = 48;
    var container = document.getElementById('wordCloudContainer');
    var cw = container.clientWidth, ch = container.clientHeight;
    var placedWords = [];
    // 按频率从高到低放置词语（越重要的词越先放置）&#8203;:contentReference[oaicite:3]{index=3}
    freqList.forEach(([word, count]) => {
      // 计算字体大小
      let size = (maxFreq === minFreq) ? (minFont + maxFont) / 2 
               : minFont + (count - minFreq) / (maxFreq - minFreq) * (maxFont - minFont);
      size = Math.round(size);
      let span = document.createElement('span');
      span.textContent = word;
      span.style.position = 'absolute';
      span.style.fontSize = size + 'px';
      span.style.fontWeight = 'bold';
      span.style.whiteSpace = 'nowrap';
      container.appendChild(span);
      // 获取元素尺寸
      let w = span.offsetWidth;
      let h = span.offsetHeight;
      // 初始放在中心
      let centerX = cw / 2, centerY = ch / 2;
      let x = centerX - w / 2;
      let y = centerY - h / 2;
      let placed = false;
      let radius = 0, angle = 0;
      const step = 5, angleStep = 15;
      // 螺旋移动寻找空位
      while (!placed && radius < Math.max(cw, ch)) {
        // 检查是否与已放置的词重叠
        let overlap = false;
        for (let other of placedWords) {
          if (!(x + w < other.x || x > other.x + other.w || y + h < other.y || y > other.y + other.h)) {
            overlap = true;
            break;
          }
        }
        if (!overlap) {
          placed = true;
          span.style.left = x + 'px';
          span.style.top = y + 'px';
          placedWords.push({ x, y, w, h });
          // 绑定点击复制事件
          span.style.cursor = 'pointer';
          span.addEventListener('click', () => copyToClipboard(word));
        } else {
          // 沿螺旋移动
          angle += angleStep;
          if (angle >= 360) {
            angle -= 360;
            radius += step;
          }
          let rad = angle * Math.PI / 180;
          x = centerX + radius * Math.cos(rad) - w / 2;
          y = centerY + radius * Math.sin(rad) - h / 2;
          // 边界检测，确保词云在容器内
          if (x < 0) x = 0;
          if (y < 0) y = 0;
          if (x + w > cw) x = cw - w;
          if (y + h > ch) y = ch - h;
        }
        if (radius >= Math.max(cw, ch) && !placed) {
          // 未能放置该词，则移除
          span.remove();
          break;
        }
      }
    });
  }

  // 设置事件监听
  var toggleBtn = document.getElementById('toggleStream');
  var speedSlider = document.getElementById('speedSlider');
  var searchBtn = document.getElementById('searchBtn');
  var resetBtn = document.getElementById('resetBtn');
  var backBtn = document.getElementById('backBtn');
  var wordCloudBtn = document.getElementById('wordCloudBtn');

  // 当前速度 (ms/条)，根据滑块值计算（左慢右快）
  var currentSpeed = 1000;  // 初始1000ms/条（滑块值100对应1000ms）
  // 更新速度显示
  document.getElementById('speedVal').textContent = currentSpeed + " ms/条";

  toggleBtn.addEventListener('click', () => {
    if (!isStreaming) {
      startStreaming();
    } else {
      stopStreaming();
    }
  });
  speedSlider.addEventListener('input', () => {
    // 滑块值value在100(左)到1000(右)，转换实际间隔ms：value越小，间隔越大
    let val = parseInt(speedSlider.value);
    currentSpeed = (1000 - (val - 100));
    document.getElementById('speedVal').textContent = currentSpeed + " ms/条";
  });
  // 监听弹幕容器滚动事件，实现拖动暂停自动滚动
  document.getElementById('bulletContainer').addEventListener('scroll', () => {
    if (isStreaming) {
      userScrolling = true;
      clearTimeout(resumeTimer);
      // 5秒无操作则恢复自动滚动当前弹幕
      resumeTimer = setTimeout(() => {
        userScrolling = false;
        if (isStreaming && currentDisplayed >= 0 && currentDisplayed < bulletElems.length) {
          bulletElems[currentDisplayed].scrollIntoView({ block: "center" });
        }
      }, 5000);
    }
  });
  // 搜索按钮和回车搜索
  searchBtn.addEventListener('click', performSearch);
  document.getElementById('searchInput').addEventListener('keydown', (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      performSearch();
    }
  });
  // 重置搜索
  resetBtn.addEventListener('click', resetSearch);
  // 回到搜索结果
  backBtn.addEventListener('click', () => {
    performSearch();
  });
  // 词频云按钮
  wordCloudBtn.addEventListener('click', () => {
    var overlay = document.getElementById('wordCloudOverlay');
    if (overlay.style.display === 'none' || overlay.style.display === '') {
      if (!wordCloudGenerated) {
        generateWordCloud();
        wordCloudGenerated = true;
      }
      overlay.style.display = 'block';
      wordCloudBtn.textContent = "关闭词频云";
    } else {
      overlay.style.display = 'none';
      wordCloudBtn.textContent = "词频云";
    }
  });

  // 初始绘制密度图和颜色条
  drawChart(false);
  drawColorBar(false);
</script>

</body>
</html>
