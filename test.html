<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>µ¯Ä»Ê¾Àý£ºËÑË÷¡¢Ìø×ª¡¢Á÷Ê½¡¢Ê±¼ä¸ñÊ½µÈ¹¦ÄÜ</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
    }
    header, footer {
      padding: 10px;
      background: #333;
      color: #fff;
    }
    main {
      display: flex;
      height: calc(100vh - 100px); /* ¼õÈ¥header+footer´ó¸Å¸ß¶È */
    }
    /* ×ó²àÃæ°å */
    #left-panel {
      width: 260px;
      border-right: 1px solid #ccc;
      padding: 10px;
      background: #f1f1f1;
      box-sizing: border-box;
      overflow-y: auto;
    }
    #left-panel h2 {
      margin-top: 0;
    }
    .row {
      margin-bottom: 10px;
    }

    /* µ¯Ä»ÁÐ±íÇøÓò */
    #danmu-container {
      flex: 1;
      background: #fff;
      overflow-y: auto;
      padding: 10px;
      box-sizing: border-box;
      position: relative;
    }
    .danmu-line {
      margin: 3px 0;
      padding: 3px;
      cursor: pointer;  /* Êó±ê·ÅÉÏ¿Éµã»÷ */
      transition: background 0.1s;
    }
    .danmu-line:hover {
      background: #fafafa;
    }
    .danmu-line.highlighted {
      background: #ffe58f;  /* µ±Ç°Á÷Ê½²¥·Å¸ßÁÁ */
      border-left: 3px solid #f90;
    }
    .time-label {
      color: #666;
      margin-right: 8px;
      font-size: 0.9em;
    }
    .highlight {
      background: yellow;  /* ËÑË÷´Ê¸ßÁÁ */
    }

    /* ÕÛµþµÄÁ÷Ê½²¥·Å¿ØÖÆ */
    #stream-controls {
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      background: #fafafa;
      display: none; /* Ä¬ÈÏÒþ²Ø£¬µã»÷¡°Á÷Ê½¡±°´Å¥Ê±Õ¹¿ª */
    }
  </style>
</head>
<body>
<header>
  <h1>µ¯Ä»Ê¾Àý</h1>
</header>

<main>
  <!-- ×ó²àÃæ°å£º¼ÓÔØ/ËÑË÷/Ìø×ª/Á÷Ê½/»Øµ½¿ªÍ·µÈ -->
  <div id="left-panel">
    <!-- 1) ¼ÓÔØXML -->
    <div class="row">
      <h2>¼ÓÔØ XML</h2>
      <input type="file" id="xmlFile" accept=".xml"/><br/>
      <button onclick="onLoadFile()">¼ÓÔØ</button>
      <br/><br/>
      <input type="text" id="xmlUrl" placeholder="https://example.com/danmu.xml" size="20"/>
      <button onclick="onLoadUrl()">¼ÓÔØ</button>
      <div id="errorMsg" style="color:red; margin-top:5px;"></div>
    </div>

    <!-- 2) ËÑË÷µ¯Ä» -->
    <div class="row">
      <h2>ËÑË÷</h2>
      <input type="text" id="searchInput" placeholder="ÊäÈë¹Ø¼ü×Ö" size="15"/>
      <button onclick="doSearch()">ËÑË÷</button>
      <button onclick="clearSearch()">ÖØÖÃ</button>
    </div>

    <!-- 3) Ê±¼äÌø×ª -->
    <div class="row">
      <h2>Ê±¼äÌø×ª</h2>
      <input type="text" id="jumpTimeInput" placeholder="Èç 120 »ò 00:02:00" size="10"/>
      <button onclick="manualJump()">Ìø×ª</button>
    </div>

    <!-- 4) ²¥·Å¿ØÖÆ (Ä¬ÈÏÒþ²Ø) -->
    <div class="row">
      <button onclick="rewind()">»Øµ½¿ªÍ·</button>
      <button onclick="toggleStreamPanel()">Á÷Ê½</button>
    </div>

    <div id="stream-controls">
      <button onclick="startPlayback()">²¥·Å</button>
      <button onclick="pausePlayback()">ÔÝÍ£</button>
      <button onclick="resumePlayback()">»Ö¸´</button>
      <br/><br/>
      <label>²¥·ÅËÙ¶È(ºÁÃë/Ìõ)£º</label>
      <input type="range" id="speedRange" min="50" max="5000" step="50" value="1000" oninput="onSpeedChange()"/>
      <span id="speedLabel">1000</span>
    </div>
  </div>

  <!-- µ¯Ä»ÏÔÊ¾ -->
  <div id="danmu-container"></div>
</main>

<footer>
  <p style="margin:0; text-align:center;">
    ½ö×÷Ê¾Àý£¬Ö§³Ö£ºËÑË÷/µã»÷Ìø×ª¡¢ÊÖ¶¯Ê±¼äÌø×ª¡¢Á÷Ê½¸ßÁÁ¡¢×Ô¶¯¹ö¶¯¾ÓÖÐ
  </p>
</footer>

<script>

/** ===================== È«¾ÖÊý¾Ý ===================== */
let danmuData = [];     // Ô­Ê¼µ¯Ä» { time: number, text: string }
let filteredData = [];  // ËÑË÷Ö®ºó±£ÁôµÄµ¯Ä»
let currentIndex = 0;   // Á÷Ê½²¥·Åµ±Ç°Ë÷Òý
let isPlaying = false;  // ÊÇ·ñÔÚ²¥·Å
let timer = null;       // setInterval¾ä±ú
let speed = 1000;       // ²¥·ÅËÙ¶È ms/Ìõ

// ========== ½âÎö²¢¼ÓÔØXML  ==========
function onLoadFile() {
  const fileInput = document.getElementById('xmlFile');
  const file = fileInput.files[0];
  if (!file) {
    showError('ÇëÑ¡ÔñXMLÎÄ¼þ');
    return;
  }
  clearError();
  const reader = new FileReader();
  reader.onload = e => {
    handleXmlString(e.target.result);
  };
  reader.onerror = () => showError('ÎÄ¼þ¶ÁÈ¡Ê§°Ü');
  reader.readAsText(file, 'utf-8');
}

function onLoadUrl() {
  const url = document.getElementById('xmlUrl').value.trim();
  if (!url) {
    showError('ÇëÊäÈëURLµØÖ·');
    return;
  }
  clearError();
  fetch(url)
    .then(resp => {
      if (!resp.ok) {
        throw new Error('ÍøÂçÇëÇóÊ§°Ü£¬×´Ì¬Âë: ' + resp.status);
      }
      return resp.text();
    })
    .then(text => {
      handleXmlString(text);
    })
    .catch(err => {
      showError('¼ÓÔØÊ§°Ü: ' + err.message);
    });
}

function handleXmlString(xmlStr) {
  try {
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlStr, 'application/xml');

    if (xmlDoc.querySelector('parsererror')) {
      throw new Error('XML¸ñÊ½½âÎöÊ§°Ü');
    }

    // ÌáÈ¡ <d> ½Úµã
    const dNodes = xmlDoc.getElementsByTagName('d');
    danmuData = [];
    for (let i=0; i<dNodes.length; i++) {
      const dEl = dNodes[i];
      const pAttr = dEl.getAttribute('p') || '';
      const text = dEl.textContent || '';
      let timeVal = 0;
      const parts = pAttr.split(',');
      if (parts.length > 0) {
        const t = parseFloat(parts[0]);
        if (!isNaN(t)) {
          timeVal = t;
        }
      }
      danmuData.push({ time: timeVal, text });
    }

    // °´Ê±¼äÉýÐò
    danmuData.sort((a,b) => a.time - b.time);
    // ¸´ÖÆ¸ø filteredData ²¢äÖÈ¾
    filteredData = danmuData.slice();
    resetPlayback();  // »áäÖÈ¾È«²¿µ¯Ä»
    if (danmuData.length === 0) {
      showError('XMLÖÐÎ´ÕÒµ½ÈÎºÎµ¯Ä»');
    } else {
      clearError();
    }
  } catch(err) {
    showError('XML´¦ÀíÊ§°Ü: ' + err.message);
  }
}

// ========== ËÑË÷ & ¸ßÁÁµã»÷Ìø×ª ==========
function doSearch() {
  const kw = document.getElementById('searchInput').value.trim();
  if (!kw) {
    // Èô¹Ø¼ü´ÊÎª¿Õ£¬Ôò»Ö¸´È«²¿
    filteredData = danmuData.slice();
    resetPlayback();
    return;
  }
  filteredData = danmuData.filter(item => item.text.includes(kw));
  resetPlayback();
}
function clearSearch() {
  document.getElementById('searchInput').value = '';
  filteredData = danmuData.slice();
  resetPlayback();
}

// ========== ÊÖ¶¯Ê±¼äÌø×ª ==========
function manualJump() {
  const val = document.getElementById('jumpTimeInput').value.trim();
  if (!val) return;
  // Ö§³Ö "120" (Ãë) »ò "00:02:00" (Ê±:·Ö:Ãë)
  const secs = parseTimeString(val);
  jumpToTime(secs);
  document.getElementById('jumpTimeInput').value = '';
}

// ½«ÐÎÈç "00:01:10" ×ª»»Îª×ÜÃëÊý
function parseTimeString(str) {
  // Èç¹ûÖ»°üº¬Êý×Ö£¬ÔòÖ±½Ó×ª»»
  if (/^\d+$/.test(str)) {
    return parseFloat(str);
  }
  // Èô°üº¬Ã°ºÅ
  const parts = str.split(':').map(n=>parseFloat(n));
  let sec = 0;
  if (parts.length === 1) {
    sec = parts[0];
  } else if (parts.length === 2) {
    // mm:ss
    sec = parts[0]*60 + parts[1];
  } else if (parts.length === 3) {
    // hh:mm:ss
    sec = parts[0]*3600 + parts[1]*60 + parts[2];
  }
  return sec;
}

// ========== Ê±¼ä¸ñÊ½»¯ hh:mm:ss ==========
function formatTime(sec) {
  if (!sec || sec<0) sec=0;
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = Math.floor(sec%60);
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

// ========== µ¯Ä»ÈÝÆ÷äÖÈ¾£ºÄ¬ÈÏÏÔÊ¾È«²¿ ==========
function renderAllDanmu() {
  const container = document.getElementById('danmu-container');
  container.innerHTML = '';
  if (filteredData.length === 0) {
    container.innerHTML = '<p>ÎÞµ¯Ä»</p>';
    return;
  }
  filteredData.forEach((item, idx) => {
    const line = document.createElement('div');
    line.className = 'danmu-line';
    line.innerHTML = `<span class="time-label">[${formatTime(item.time)}]</span> ${highlightIfNeeded(item.text)}`;
    // µã»÷Ìø×ªµ½¸Ãµ¯Ä»Ê±¼ä
    line.addEventListener('click', () => {
      jumpToTime(item.time);
    });
    container.appendChild(line);
  });
}

// ËÑË÷¹Ø¼ü´Ê¸ßÁÁ
function highlightIfNeeded(text) {
  const kw = document.getElementById('searchInput').value.trim();
  if (!kw) return text;
  // ¼òµ¥µÄÈ«²¿Ìæ»»
  return text.replaceAll(kw, `<span class="highlight">${kw}</span>`);
}

// ========== Ê±¼äÌø×ª (¾«×¼µ½ filteredData) ==========
function jumpToTime(targetSec) {
  // ÕÒµ½ filteredData ÖÐ >= targetSec µÄË÷Òý
  const idx = filteredData.findIndex(d => d.time >= targetSec);
  if (idx < 0) {
    // ´óÓÚËùÓÐÊ±¼ä£¬ÔòÌøµ½×îºó
    currentIndex = filteredData.length;
  } else {
    currentIndex = idx;
  }
  // ÈôÒÑÔÚÁ÷Ê½²¥·Å£¬¾ÍÖØ»æ»òÏÈÔÝÍ£
  // ÕâÀï×ö¼òµ¥´¦Àí£ºÖØ»æ²¢±£³ÖÔ­²¥·Å×´Ì¬
  renderAllDanmu();
  if (isPlaying) {
    // Ç¿ÖÆÈÃÏÂÒ»Ìõ²¥·ÅÊÇ currentIndex
    // highlightCurrent() ºóÒ²¿É×Ô¶¯¹ö¶¯
    highlightCurrent();
  } else {
    // ²»ÔÚ²¥·ÅÊ±£¬Ö±½Ó¹öµ½ÄÇÒ»Ìõ
    scrollToLine(currentIndex);
  }
}

// ¹ö¶¯Ê¹µÚ idx ÌõÔÚÈÝÆ÷ÖÐÑë
function scrollToLine(idx) {
  const container = document.getElementById('danmu-container');
  const lineEls = container.getElementsByClassName('danmu-line');
  if (idx < 0 || idx >= lineEls.length) return;
  const line = lineEls[idx];
  // ¼ÆËãÒª¹ö¶¯µÄÆ«ÒÆÁ¿
  const containerRect = container.getBoundingClientRect();
  const lineRect = line.getBoundingClientRect();
  const offset = (lineRect.top + lineRect.height/2) - (containerRect.top + containerRect.height/2);
  container.scrollTop += offset;
}

// ========== Á÷Ê½²¥·Å¹¦ÄÜ ==========
// Ä¬ÈÏÖ»ÏÔÊ¾Ò»¸ö¡°»Øµ½¿ªÍ·¡±ºÍ¡°Á÷Ê½¡±°´Å¥
// µ±µã»÷¡°Á÷Ê½¡±Ê±²ÅÕ¹¿ªÆäËü²¥·Å°´Å¥

function toggleStreamPanel() {
  const panel = document.getElementById('stream-controls');
  if (panel.style.display === 'none') {
    panel.style.display = 'block';
  } else {
    panel.style.display = 'none';
  }
}

function startPlayback() {
  // Ã¿´Îµã»÷²¥·Å£¬ÏÈ´ÓÍ·¿ªÊ¼
  resetPlayback();
  if (filteredData.length === 0) {
    showError('ÎÞµ¯Ä»¿É²¥·Å');
    return;
  }
  isPlaying = true;
  timer = setInterval(playNext, speed);
}

function pausePlayback() {
  isPlaying = false;
  stopTimer();
}

function resumePlayback() {
  if (!isPlaying && currentIndex < filteredData.length) {
    isPlaying = true;
    timer = setInterval(playNext, speed);
  }
}

function rewind() {
  resetPlayback();
}

function resetPlayback() {
  stopTimer();
  isPlaying = false;
  currentIndex = 0;
  renderAllDanmu();
}

// Ã¿´Î²¥·ÅÒ»Ìõ
function playNext() {
  if (currentIndex >= filteredData.length) {
    stopTimer();
    isPlaying = false;
    return;
  }
  highlightCurrent();
  currentIndex++;
}

// ¸ßÁÁµ±Ç°µ¯Ä» & Ê¹Æä¹ö¶¯µ½ÈÝÆ÷ÖÐÑë
function highlightCurrent() {
  const container = document.getElementById('danmu-container');
  const lineEls = container.getElementsByClassName('danmu-line');
  // ÏÈÇå³ýËùÓÐhighlighted
  for (let el of lineEls) {
    el.classList.remove('highlighted');
  }
  if (currentIndex < 0 || currentIndex >= lineEls.length) return;
  const targetLine = lineEls[currentIndex];
  targetLine.classList.add('highlighted');
  scrollToLine(currentIndex);
}

function stopTimer() {
  if (timer) {
    clearInterval(timer);
    timer = null;
  }
}

// ========== ËÙ¶Èµ÷½Ú ==========
function onSpeedChange() {
  const val = document.getElementById('speedRange').value;
  speed = parseInt(val, 10);
  document.getElementById('speedLabel').textContent = speed;
  if (isPlaying) {
    // Í£Ö¹Ô­¶¨Ê±Æ÷£¬ÖØÐÂÆô¶¯
    stopTimer();
    timer = setInterval(playNext, speed);
  }
}

// ========== ²¥·ÅÖØÖÃÊ±µÄÄ¬ÈÏäÖÈ¾(ÏÔÊ¾È«²¿) ==========
function resetPlayback() {
  stopTimer();
  isPlaying = false;
  currentIndex = 0;
  renderAllDanmu();
}

// ========== ¹¤¾ßº¯Êý: ´íÎóÌáÊ¾ ==========
function showError(msg) {
  document.getElementById('errorMsg').textContent = msg;
}
function clearError() {
  document.getElementById('errorMsg').textContent = '';
}
</script>

</body>
</html>
