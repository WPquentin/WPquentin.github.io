<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <title>Danmu Demo Rebuild</title>
  <!-- ECharts & WordCloud (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2/dist/echarts-wordcloud.min.js"></script>
  <style>
    body { margin:20px; font-family: sans-serif; }
    .toolbar { margin-bottom:10px; }
    .toolbar label { font-weight:bold; margin-right:5px; }
    .toolbar input, .toolbar button, .toolbar select { margin-right:10px; }

    #errorMsg { color:red; margin-top:5px; }
    #searchStatus { color: #666; font-size:0.9em; }

    /* 弹幕区域 */
    #danmuContainer {
      border:1px solid #ccc; 
      width:600px; height:300px;
      padding:5px; box-sizing:border-box;
      overflow-y:auto; background:#fafafa;
      margin-bottom:10px;
    }
    .danmu-line { margin:3px 0; cursor:pointer; }
    .danmu-line:hover { background:#f9f9f9; }
    .current { background:#ffe58f; border-left:3px solid #f90; padding-left:3px; }

    /* 折线图 */
    #chartPanel {
      width:600px; height:200px; border:1px solid #ccc; margin-bottom:10px;
    }

    /* 词云弹窗 */
    #wordCloudOverlay {
      display:none; position:fixed; 
      top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); z-index:999;
    }
    #wordCloudContainer {
      position:absolute; left:50%; top:50%;
      transform: translate(-50%, -50%);
      width: 80%; height: 80%;
      background:#fff; border:1px solid #ccc;
      box-sizing:border-box;
    }
    #closeWcBtn {
      position:absolute; top:5px; right:5px;
      background:#ccc; border:none; padding:3px 8px;
      cursor:pointer;
    }
    #copyMsg {
      position:absolute; bottom:10px; width:100%; 
      text-align:center; color:green; display:none;
    }
  </style>
</head>
<body>

<!-- 1. 加载XML -->
<div class="toolbar">
  <label>XML文件:</label>
  <input type="file" id="xmlFile" accept=".xml"/>
  <button id="loadFileBtn">加载</button>

  <label>XML链接:</label>
  <input type="text" id="xmlUrl" size="30" placeholder="https://example.com/danmu.xml"/>
  <button id="loadUrlBtn">加载</button>
  <div id="errorMsg"></div>
</div>

<!-- 2. 过滤drop -->
<div class="toolbar">
  <label>Drop弹幕:</label>
  <input type="text" id="dropWords" value="哈哈,喝水" size="15"/>
  <span style="color:#666;font-size:0.9em;">(默认过滤这些关键词)</span>
</div>

<!-- 3. 搜索 & 播放 & 跳转等 -->
<div class="toolbar">
  <label>搜索:</label>
  <input type="text" id="searchInput" placeholder="多关键词空格分隔" size="15"/>
  <label><input type="radio" name="searchMode" value="AND"/>且</label>
  <label><input type="radio" name="searchMode" value="OR" checked/>或</label>
  <button id="searchBtn">搜索</button>
  <button id="exitSearchBtn">退出搜索</button>
  <span id="searchStatus">无搜索</span>
</div>

<div class="toolbar">
  <button id="wordCloudBtn">词云</button>
  <button id="playBtn">播放</button>
  <label>速度(条/秒):</label>
  <input type="range" id="speedRange" min="1" max="10" step="1" value="2"/>
  <span id="speedVal">2</span>
  <button id="rewindBtn">回到开头</button>

  <label style="margin-left:15px;">跳转:</label>
  <input type="text" id="jumpInput" size="8" placeholder="120 or 00:02:00"/>
  <button id="jumpBtn">跳转</button>
</div>

<!-- 弹幕列表 -->
<div id="danmuContainer"></div>

<!-- 折线图 -->
<div id="chartPanel"></div>

<!-- 词云Overlay -->
<div id="wordCloudOverlay">
  <div id="wordCloudContainer">
    <button id="closeWcBtn">关闭</button>
    <div id="copyMsg">词已复制</div>
  </div>
</div>

<script>
// ============= 全局变量 =============
let danmus = [];  // [{time, text}] 过滤drop后
let isPlaying = false;
let currentIndex = 0;
let playTimer = null;
let playbackSpeed = 2;
let partialCount = 0; // 用于累加条数

let searchActive = false;
let matchedIndices = [];
let searchKeywords = [];
let searchMode = 'OR';

let chart = null;  // ECharts实例
let chartData = [];  // 平滑后数组
let maxTime = 0;

let wcChart = null; // 词云图

// ============== 事件初始化 ==============
document.getElementById('loadFileBtn').addEventListener('click', loadFromFile);
document.getElementById('loadUrlBtn').addEventListener('click', loadFromUrl);
document.getElementById('searchBtn').addEventListener('click', doSearch);
document.getElementById('exitSearchBtn').addEventListener('click', exitSearch);
document.getElementById('wordCloudBtn').addEventListener('click', showWordCloud);
document.getElementById('closeWcBtn').addEventListener('click', ()=> {
  document.getElementById('wordCloudOverlay').style.display='none';
});
document.getElementById('playBtn').addEventListener('click', togglePlay);
document.getElementById('speedRange').addEventListener('input', onSpeedChange);
document.getElementById('rewindBtn').addEventListener('click', rewind);
document.getElementById('jumpBtn').addEventListener('click', doJump);

/** ============ 1. 加载XML ============ */
function loadFromFile(){
  const fInput = document.getElementById('xmlFile');
  if (!fInput.files.length){
    showError('请选择XML文件');
    return;
  }
  clearError();
  const file = fInput.files[0];
  const reader = new FileReader();
  reader.onload = e => {
    parseXmlString(e.target.result);
  };
  reader.onerror = () => showError('文件读取失败');
  reader.readAsText(file, 'utf-8');
}

function loadFromUrl(){
  const url = document.getElementById('xmlUrl').value.trim();
  if (!url){
    showError('请输入URL地址');
    return;
  }
  clearError();
  fetch(url)
    .then(resp => {
      if(!resp.ok) throw new Error('HTTP错误:'+resp.status);
      return resp.text();
    })
    .then(txt => parseXmlString(txt))
    .catch(e => showError('加载失败:'+ e.message));
}

function parseXmlString(xmlStr){
  try{
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlStr, 'application/xml');
    if (xmlDoc.querySelector('parsererror')){
      throw new Error('XML格式不正确');
    }
    // 提取 <d>标签
    const dList = xmlDoc.getElementsByTagName('d');
    danmus = [];
    const dropArr = document.getElementById('dropWords').value.split(',').map(a=>a.trim()).filter(Boolean);

    for (let i=0; i<dList.length; i++){
      const el = dList[i];
      const p = el.getAttribute('p') || '';
      const text = el.textContent.trim();
      let timeVal = 0;
      const parts = p.split(',');
      if(parts[0]) {
        let t = parseFloat(parts[0]);
        if(!isNaN(t)) timeVal=t;
      }
      // 默认过滤
      let dropped=false;
      for (let dw of dropArr){
        if(text.includes(dw)){
          dropped=true; 
          break;
        }
      }
      if(!dropped){
        danmus.push({time:timeVal, text});
      }
    }
    danmus.sort((a,b)=> a.time-b.time);
    if(!danmus.length) showError('弹幕为空或全部被过滤');

    // 重置
    resetPlayback();
    renderDanmuList();
    buildChartData();
    initChart();
    buildWordCloudData();

    clearError();
  }catch(e){
    showError('XML解析失败:'+ e.message);
  }
}

function showError(msg){
  document.getElementById('errorMsg').textContent= msg;
}
function clearError(){
  document.getElementById('errorMsg').textContent='';
}

/** ============ 2. 弹幕列表 & 点击事件 ============ */
function renderDanmuList(){
  const container = document.getElementById('danmuContainer');
  container.innerHTML='';
  for(let i=0; i<danmus.length; i++){
    const d = danmus[i];
    let div = document.createElement('div');
    div.className='danmu-line';
    div.dataset.idx = i;
    div.innerHTML = `[${fmtTime(d.time)}] ${d.text}`;
    div.addEventListener('click', ()=>{
      highlightLine(i);
      currentIndex=i;
      if(!isPlaying) togglePlay(true); // 不在播放时，点击后自动开始
    });
    container.appendChild(div);
  }
}
function fmtTime(sec){
  let m = Math.floor(sec/60);
  let s = Math.floor(sec%60);
  return (m<10?'0'+m:m)+':'+(s<10?'0'+s:s);
}

/** ============ 3. 搜索 & 退出搜索 ============ */
function doSearch(){
  const val = document.getElementById('searchInput').value.trim().toLowerCase();
  if(!val){
    showError('搜索关键词为空');
    return;
  }
  clearError();
  searchActive=true;
  searchKeywords = val.split(/\s+/).filter(Boolean);
  searchMode = document.querySelector('input[name="searchMode"]:checked').value; // AND or OR

  matchedIndices=[];
  for(let i=0; i<danmus.length; i++){
    let textLow = danmus[i].text.toLowerCase();
    let isMatch=false;
    if(searchMode==='AND'){
      isMatch = searchKeywords.every(kw => textLow.includes(kw));
    } else {
      // OR
      isMatch = searchKeywords.some(kw => textLow.includes(kw));
    }
    if(isMatch) matchedIndices.push(i);
  }

  document.getElementById('searchStatus').textContent = `搜索(${searchMode}):${searchKeywords.join(',')} => ${matchedIndices.length}条`;
  // 更新图(只显示匹配)
  buildChartData(matchedIndices);
  updateChart();
}

function exitSearch(){
  searchActive=false;
  matchedIndices=[];
  searchKeywords=[];
  document.getElementById('searchStatus').textContent='无搜索';
  buildChartData();
  updateChart();
}

/** ============ 4. 流式播放(每秒N条) ============ */
function togglePlay(forcePlay=false){
  if(!danmus.length) return;
  if(forcePlay){
    if(isPlaying) return;
    isPlaying=true;
  } else {
    isPlaying = !isPlaying;
  }
  document.getElementById('playBtn').textContent = isPlaying?'暂停':'播放';
  if(isPlaying){
    let interval=100; //ms
    clearInterval(playTimer);
    playTimer = setInterval(()=>{
      let inc = playbackSpeed*(interval/1000);
      if(inc<1){
        partialCount+=inc;
        while(partialCount>=1){
          partialCount-=1;
          showNext();
        }
      } else {
        let intPart = Math.floor(inc);
        for(let i=0; i<intPart; i++){
          showNext();
        }
        partialCount += (inc-intPart);
        while(partialCount>=1){
          partialCount-=1;
          showNext();
        }
      }
    }, interval);
  } else {
    clearInterval(playTimer);
  }
}
function showNext(){
  if(currentIndex>=danmus.length){
    // 结束
    clearInterval(playTimer);
    isPlaying=false;
    document.getElementById('playBtn').textContent='播放';
    return;
  }
  highlightLine(currentIndex);
  currentIndex++;
}
function highlightLine(idx){
  const lines = document.querySelectorAll('#danmuContainer .danmu-line');
  lines.forEach(l=> l.classList.remove('current'));
  if(idx<0||idx>=lines.length) return;
  let target = lines[idx];
  target.classList.add('current');
  target.scrollIntoView({block:'center'});
}

function rewind(){
  clearInterval(playTimer);
  isPlaying=false;
  currentIndex=0;
  partialCount=0;
  document.getElementById('playBtn').textContent='播放';
  // 去掉高亮
  const lines = document.querySelectorAll('#danmuContainer .danmu-line');
  lines.forEach(l=>l.classList.remove('current'));
  if(lines.length>0) lines[0].scrollIntoView({block:'center'});
}

function onSpeedChange(){
  let val = parseInt(document.getElementById('speedRange').value);
  playbackSpeed=val;
  document.getElementById('speedVal').textContent=val;
}

/** ============ 5. 时间跳转 ============ */
function doJump(){
  let input = document.getElementById('jumpInput').value.trim();
  if(!input) return;
  let sec = parseTimeInput(input);
  // 找最近
  let idx=-1, minDiff=1e9;
  for(let i=0; i<danmus.length; i++){
    let diff = Math.abs(danmus[i].time - sec);
    if(diff<minDiff){ minDiff=diff; idx=i; }
  }
  if(idx>=0){
    highlightLine(idx);
    currentIndex=idx;
    if(!isPlaying) togglePlay(true);
  }
}

function parseTimeInput(str){
  if(/^\d+$/.test(str)) return parseInt(str,10);
  let parts = str.split(':').map(x=>parseInt(x,10));
  if(parts.length===2){
    return parts[0]*60+ parts[1];
  } else if(parts.length===3){
    return parts[0]*3600 + parts[1]*60 + parts[2];
  }
  return 0;
}

/** ============ 6. 折线图(平滑 & 点击任意处) ============ */
function buildChartData(indices){
  if(!danmus.length){
    chartData=[]; maxTime=0; return;
  }
  let lastSec = Math.ceil(danmus[danmus.length-1].time);
  maxTime = lastSec;
  let raw = new Array(lastSec+1).fill(0);

  if(indices && indices.length){
    // 只统计matched
    for(let i of indices){
      let t = Math.floor(danmus[i].time);
      if(t>=0&&t<raw.length) raw[t]++;
    }
  } else if(searchActive){
    // searchActive但没匹配 => 全0
  } else {
    // 全弹幕
    for(let d of danmus){
      let t=Math.floor(d.time);
      if(t>=0 && t<raw.length) raw[t]++;
    }
  }

  // 平滑(滑动窗口=5)
  let windowSize=5;
  let smoothed = new Array(raw.length).fill(0);
  for(let i=0; i<raw.length; i++){
    let sum=0, count=0;
    for(let w=-2; w<=2; w++){
      let idx=i+w;
      if(idx>=0 && idx<raw.length){ sum+=raw[idx]; count++; }
    }
    if(count>0) smoothed[i]=sum/count;
  }
  chartData=smoothed;
}

function initChart(){
  if(!chart){
    chart = echarts.init(document.getElementById('chartPanel'));
    chart.setOption({
      tooltip:{ triggerOn:'none' }, // we use custom click
      xAxis:{
        type:'value',
        axisLabel:{
          formatter: (v)=>{
            let m=Math.floor(v/60), s=Math.floor(v%60);
            return m+':'+(s<10?'0'+s:s);
          }
        }
      },
      yAxis:{ type:'value', name:'弹幕数(平滑)' },
      series:[{
        type:'line',
        data:[],
        smooth:true,
        showSymbol:false,
        areaStyle:{}
      }]
    });
    chart.getZr().on('click', (params)=>{
      let pt=[params.offsetX, params.offsetY];
      let inv= chart.convertFromPixel({seriesIndex:0}, pt);
      let xVal= inv[0];
      if(xVal<0) xVal=0; 
      if(xVal>maxTime) xVal=maxTime;
      // 找nearest
      let idx=-1, minD=1e9;
      for(let i=0; i<danmus.length; i++){
        let diff=Math.abs(danmus[i].time - xVal);
        if(diff<minD){ minD=diff; idx=i;}
      }
      if(idx>=0){
        highlightLine(idx);
        currentIndex=idx;
        if(!isPlaying) togglePlay(true);
      }
    });
  }
  updateChart();
}

function updateChart(){
  if(!chart) return;
  chart.setOption({
    xAxis:{ max: chartData.length-1 },
    series:[{
      data: chartData.map((val,idx)=>[idx,val])
    }]
  });
}

/** ============ 7. 词云(可关闭/点击复制) ============ */
function buildWordCloudData(){
  // 统计词频
  let freqMap={};
  for(let d of danmus){
    let txt = reduceRepeat(d.text); // 如 "晚安晚安晚安" => "晚安"
    // 拆词(限制长度<=4)
    let words = txt.split(/[^A-Za-z0-9\u4e00-\u9fa5]+/).filter(Boolean);
    for(let w of words){
      if(w.length>4) continue; // 去除>4字符
      let lower = w.toLowerCase();
      freqMap[lower]=(freqMap[lower]||0)+1;
    }
  }
  let arr= Object.entries(freqMap).map(([name,value])=>({name,value}));
  arr.sort((a,b)=>b.value-a.value);
  arr=arr.slice(0,100);

  // init/更新
  if(!wcChart){
    wcChart = echarts.init(document.getElementById('wordCloudContainer'));
    wcChart.on('click',(params)=>{
      if(params.data && params.data.name){
        copyToClipboard(params.data.name);
      }
    });
  }
  let wcOption={
    tooltip:{},
    series:[{
      type:'wordCloud',
      gridSize:8,
      sizeRange:[14,60],
      rotationRange:[0,0],
      textStyle:{
        color: function(){
          return 'rgb('+
            [Math.floor(Math.random()*160),
             Math.floor(Math.random()*160),
             Math.floor(Math.random()*160)]
             .join(',')
            +')';
        }
      },
      data:arr
    }]
  };
  wcChart.setOption(wcOption);
}
function showWordCloud(){
  if(!wcChart) return;
  wcChart.resize();
  document.getElementById('wordCloudOverlay').style.display='block';
}

function reduceRepeat(str){
  // 简单判断 若整句由<=4子串重复组成 =>只保留子串
  for(let len=1; len<=4; len++){
    if(str.length%len===0){
      let sub=str.slice(0,len);
      let repeatCount=str.length/len;
      if(sub.repeat(repeatCount)===str){
        return sub;
      }
    }
  }
  return str;
}

function copyToClipboard(txt){
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(txt).then(()=>{
      showCopyMsg();
    }).catch(()=>{
      fallbackCopy(txt);
    });
  } else fallbackCopy(txt);
}
function fallbackCopy(txt){
  let ta=document.createElement('textarea');
  ta.value=txt;
  document.body.appendChild(ta);
  ta.select();
  try{document.execCommand('copy');}catch(e){}
  document.body.removeChild(ta);
  showCopyMsg();
}
function showCopyMsg(){
  let msg=document.getElementById('copyMsg');
  msg.style.display='block';
  setTimeout(()=>{msg.style.display='none';},1500);
}

/** =========== 重置播放状态 =========== */
function resetPlayback(){
  clearInterval(playTimer);
  isPlaying=false;
  currentIndex=0;
  partialCount=0;
  document.getElementById('playBtn').textContent='播放';
  // 清空高亮
  let lines=document.querySelectorAll('#danmuContainer .danmu-line');
  lines.forEach(l=>l.classList.remove('current'));
}
</script>

</body>
</html>
