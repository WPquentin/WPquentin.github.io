<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>弹幕示例：搜索、跳转、流式、时间格式等功能</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
    }
    header, footer {
      padding: 10px;
      background: #333;
      color: #fff;
    }
    main {
      display: flex;
      height: calc(100vh - 100px); /* 减去header+footer大概高度 */
    }
    /* 左侧面板 */
    #left-panel {
      width: 260px;
      border-right: 1px solid #ccc;
      padding: 10px;
      background: #f1f1f1;
      box-sizing: border-box;
      overflow-y: auto;
    }
    #left-panel h2 {
      margin-top: 0;
    }
    .row {
      margin-bottom: 10px;
    }

    /* 弹幕列表区域 */
    #danmu-container {
      flex: 1;
      background: #fff;
      overflow-y: auto;
      padding: 10px;
      box-sizing: border-box;
      position: relative;
    }
    .danmu-line {
      margin: 3px 0;
      padding: 3px;
      cursor: pointer;  /* 鼠标放上可点击 */
      transition: background 0.1s;
    }
    .danmu-line:hover {
      background: #fafafa;
    }
    .danmu-line.highlighted {
      background: #ffe58f;  /* 当前流式播放高亮 */
      border-left: 3px solid #f90;
    }
    .time-label {
      color: #666;
      margin-right: 8px;
      font-size: 0.9em;
    }
    .highlight {
      background: yellow;  /* 搜索词高亮 */
    }

    /* 折叠的流式播放控制 */
    #stream-controls {
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      background: #fafafa;
      display: none; /* 默认隐藏，点击“流式”按钮时展开 */
    }
  </style>
</head>
<body>
<header>
  <h1>弹幕示例</h1>
</header>

<main>
  <!-- 左侧面板：加载/搜索/跳转/流式/回到开头等 -->
  <div id="left-panel">
    <!-- 1) 加载XML -->
    <div class="row">
      <h2>加载 XML</h2>
      <input type="file" id="xmlFile" accept=".xml"/><br/>
      <button onclick="onLoadFile()">加载</button>
      <br/><br/>
      <input type="text" id="xmlUrl" placeholder="https://example.com/danmu.xml" size="20"/>
      <button onclick="onLoadUrl()">加载</button>
      <div id="errorMsg" style="color:red; margin-top:5px;"></div>
    </div>

    <!-- 2) 搜索弹幕 -->
    <div class="row">
      <h2>搜索</h2>
      <input type="text" id="searchInput" placeholder="输入关键字" size="15"/>
      <button onclick="doSearch()">搜索</button>
      <button onclick="clearSearch()">重置</button>
    </div>

    <!-- 3) 时间跳转 -->
    <div class="row">
      <h2>时间跳转</h2>
      <input type="text" id="jumpTimeInput" placeholder="如 120 或 00:02:00" size="10"/>
      <button onclick="manualJump()">跳转</button>
    </div>

    <!-- 4) 播放控制 (默认隐藏) -->
    <div class="row">
      <button onclick="rewind()">回到开头</button>
      <button onclick="toggleStreamPanel()">流式</button>
    </div>

    <div id="stream-controls">
      <button onclick="startPlayback()">播放</button>
      <button onclick="pausePlayback()">暂停</button>
      <button onclick="resumePlayback()">恢复</button>
      <br/><br/>
      <label>播放速度(毫秒/条)：</label>
      <input type="range" id="speedRange" min="50" max="5000" step="50" value="1000" oninput="onSpeedChange()"/>
      <span id="speedLabel">1000</span>
    </div>
  </div>

  <!-- 弹幕显示 -->
  <div id="danmu-container"></div>
</main>

<footer>
  <p style="margin:0; text-align:center;">
    仅作示例，支持：搜索/点击跳转、手动时间跳转、流式高亮、自动滚动居中
  </p>
</footer>

<script>

/** ===================== 全局数据 ===================== */
let danmuData = [];     // 原始弹幕 { time: number, text: string }
let filteredData = [];  // 搜索之后保留的弹幕
let currentIndex = 0;   // 流式播放当前索引
let isPlaying = false;  // 是否在播放
let timer = null;       // setInterval句柄
let speed = 1000;       // 播放速度 ms/条

// ========== 解析并加载XML  ==========
function onLoadFile() {
  const fileInput = document.getElementById('xmlFile');
  const file = fileInput.files[0];
  if (!file) {
    showError('请选择XML文件');
    return;
  }
  clearError();
  const reader = new FileReader();
  reader.onload = e => {
    handleXmlString(e.target.result);
  };
  reader.onerror = () => showError('文件读取失败');
  reader.readAsText(file, 'utf-8');
}

function onLoadUrl() {
  const url = document.getElementById('xmlUrl').value.trim();
  if (!url) {
    showError('请输入URL地址');
    return;
  }
  clearError();
  fetch(url)
    .then(resp => {
      if (!resp.ok) {
        throw new Error('网络请求失败，状态码: ' + resp.status);
      }
      return resp.text();
    })
    .then(text => {
      handleXmlString(text);
    })
    .catch(err => {
      showError('加载失败: ' + err.message);
    });
}

function handleXmlString(xmlStr) {
  try {
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlStr, 'application/xml');

    if (xmlDoc.querySelector('parsererror')) {
      throw new Error('XML格式解析失败');
    }

    // 提取 <d> 节点
    const dNodes = xmlDoc.getElementsByTagName('d');
    danmuData = [];
    for (let i=0; i<dNodes.length; i++) {
      const dEl = dNodes[i];
      const pAttr = dEl.getAttribute('p') || '';
      const text = dEl.textContent || '';
      let timeVal = 0;
      const parts = pAttr.split(',');
      if (parts.length > 0) {
        const t = parseFloat(parts[0]);
        if (!isNaN(t)) {
          timeVal = t;
        }
      }
      danmuData.push({ time: timeVal, text });
    }

    // 按时间升序
    danmuData.sort((a,b) => a.time - b.time);
    // 复制给 filteredData 并渲染
    filteredData = danmuData.slice();
    resetPlayback();  // 会渲染全部弹幕
    if (danmuData.length === 0) {
      showError('XML中未找到任何弹幕');
    } else {
      clearError();
    }
  } catch(err) {
    showError('XML处理失败: ' + err.message);
  }
}

// ========== 搜索 & 高亮点击跳转 ==========
function doSearch() {
  const kw = document.getElementById('searchInput').value.trim();
  if (!kw) {
    // 若关键词为空，则恢复全部
    filteredData = danmuData.slice();
    resetPlayback();
    return;
  }
  filteredData = danmuData.filter(item => item.text.includes(kw));
  resetPlayback();
}
function clearSearch() {
  document.getElementById('searchInput').value = '';
  filteredData = danmuData.slice();
  resetPlayback();
}

// ========== 手动时间跳转 ==========
function manualJump() {
  const val = document.getElementById('jumpTimeInput').value.trim();
  if (!val) return;
  // 支持 "120" (秒) 或 "00:02:00" (时:分:秒)
  const secs = parseTimeString(val);
  jumpToTime(secs);
  document.getElementById('jumpTimeInput').value = '';
}

// 将形如 "00:01:10" 转换为总秒数
function parseTimeString(str) {
  // 如果只包含数字，则直接转换
  if (/^\d+$/.test(str)) {
    return parseFloat(str);
  }
  // 若包含冒号
  const parts = str.split(':').map(n=>parseFloat(n));
  let sec = 0;
  if (parts.length === 1) {
    sec = parts[0];
  } else if (parts.length === 2) {
    // mm:ss
    sec = parts[0]*60 + parts[1];
  } else if (parts.length === 3) {
    // hh:mm:ss
    sec = parts[0]*3600 + parts[1]*60 + parts[2];
  }
  return sec;
}

// ========== 时间格式化 hh:mm:ss ==========
function formatTime(sec) {
  if (!sec || sec<0) sec=0;
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = Math.floor(sec%60);
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

// ========== 弹幕容器渲染：默认显示全部 ==========
function renderAllDanmu() {
  const container = document.getElementById('danmu-container');
  container.innerHTML = '';
  if (filteredData.length === 0) {
    container.innerHTML = '<p>无弹幕</p>';
    return;
  }
  filteredData.forEach((item, idx) => {
    const line = document.createElement('div');
    line.className = 'danmu-line';
    line.innerHTML = `<span class="time-label">[${formatTime(item.time)}]</span> ${highlightIfNeeded(item.text)}`;
    // 点击跳转到该弹幕时间
    line.addEventListener('click', () => {
      jumpToTime(item.time);
    });
    container.appendChild(line);
  });
}

// 搜索关键词高亮
function highlightIfNeeded(text) {
  const kw = document.getElementById('searchInput').value.trim();
  if (!kw) return text;
  // 简单的全部替换
  return text.replaceAll(kw, `<span class="highlight">${kw}</span>`);
}

// ========== 时间跳转 (精准到 filteredData) ==========
function jumpToTime(targetSec) {
  // 找到 filteredData 中 >= targetSec 的索引
  const idx = filteredData.findIndex(d => d.time >= targetSec);
  if (idx < 0) {
    // 大于所有时间，则跳到最后
    currentIndex = filteredData.length;
  } else {
    currentIndex = idx;
  }
  // 若已在流式播放，就重绘或先暂停
  // 这里做简单处理：重绘并保持原播放状态
  renderAllDanmu();
  if (isPlaying) {
    // 强制让下一条播放是 currentIndex
    // highlightCurrent() 后也可自动滚动
    highlightCurrent();
  } else {
    // 不在播放时，直接滚到那一条
    scrollToLine(currentIndex);
  }
}

// 滚动使第 idx 条在容器中央
function scrollToLine(idx) {
  const container = document.getElementById('danmu-container');
  const lineEls = container.getElementsByClassName('danmu-line');
  if (idx < 0 || idx >= lineEls.length) return;
  const line = lineEls[idx];
  // 计算要滚动的偏移量
  const containerRect = container.getBoundingClientRect();
  const lineRect = line.getBoundingClientRect();
  const offset = (lineRect.top + lineRect.height/2) - (containerRect.top + containerRect.height/2);
  container.scrollTop += offset;
}

// ========== 流式播放功能 ==========
// 默认只显示一个“回到开头”和“流式”按钮
// 当点击“流式”时才展开其它播放按钮

function toggleStreamPanel() {
  const panel = document.getElementById('stream-controls');
  if (panel.style.display === 'none') {
    panel.style.display = 'block';
  } else {
    panel.style.display = 'none';
  }
}

function startPlayback() {
  // 每次点击播放，先从头开始
  resetPlayback();
  if (filteredData.length === 0) {
    showError('无弹幕可播放');
    return;
  }
  isPlaying = true;
  timer = setInterval(playNext, speed);
}

function pausePlayback() {
  isPlaying = false;
  stopTimer();
}

function resumePlayback() {
  if (!isPlaying && currentIndex < filteredData.length) {
    isPlaying = true;
    timer = setInterval(playNext, speed);
  }
}

function rewind() {
  resetPlayback();
}

function resetPlayback() {
  stopTimer();
  isPlaying = false;
  currentIndex = 0;
  renderAllDanmu();
}

// 每次播放一条
function playNext() {
  if (currentIndex >= filteredData.length) {
    stopTimer();
    isPlaying = false;
    return;
  }
  highlightCurrent();
  currentIndex++;
}

// 高亮当前弹幕 & 使其滚动到容器中央
function highlightCurrent() {
  const container = document.getElementById('danmu-container');
  const lineEls = container.getElementsByClassName('danmu-line');
  // 先清除所有highlighted
  for (let el of lineEls) {
    el.classList.remove('highlighted');
  }
  if (currentIndex < 0 || currentIndex >= lineEls.length) return;
  const targetLine = lineEls[currentIndex];
  targetLine.classList.add('highlighted');
  scrollToLine(currentIndex);
}

function stopTimer() {
  if (timer) {
    clearInterval(timer);
    timer = null;
  }
}

// ========== 速度调节 ==========
function onSpeedChange() {
  const val = document.getElementById('speedRange').value;
  speed = parseInt(val, 10);
  document.getElementById('speedLabel').textContent = speed;
  if (isPlaying) {
    // 停止原定时器，重新启动
    stopTimer();
    timer = setInterval(playNext, speed);
  }
}

// ========== 播放重置时的默认渲染(显示全部) ==========
function resetPlayback() {
  stopTimer();
  isPlaying = false;
  currentIndex = 0;
  renderAllDanmu();
}

// ========== 工具函数: 错误提示 ==========
function showError(msg) {
  document.getElementById('errorMsg').textContent = msg;
}
function clearError() {
  document.getElementById('errorMsg').textContent = '';
}
</script>

</body>
</html>
