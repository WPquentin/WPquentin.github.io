<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Japan Land Sampler</title>
  <style>
    :root { color-scheme: light dark; }
    body {
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      margin: 0; min-height: 100vh; display: grid; place-items: center; padding: 24px;
      background-color: canvas; color: canvastext;
    }
    .card { width: min(600px, 100%); border: 1px solid rgba(127,127,127,.25); border-radius: 16px; padding: 32px; box-shadow: 0 4px 24px rgba(0,0,0,0.05); }
    h1 { margin: 0 0 24px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.6; font-weight: 700; }
    
    .label { font-size: 12px; font-weight: 700; opacity: 0.5; margin-bottom: 4px; text-transform: uppercase; }
    .value { font-size: clamp(24px, 5vw, 42px); font-weight: 800; line-height: 1.2; margin-bottom: 24px; }
    .sub-value { font-size: 18px; font-weight: 400; opacity: 0.8; margin-top: 4px; }
    
    .coords { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 14px; opacity: 0.6; margin-top: 32px; border-top: 1px solid rgba(127,127,127,0.2); padding-top: 16px; }
    
    button {
      width: 100%; background: canvastext; color: canvas; border: none; padding: 16px; border-radius: 12px; 
      font-size: 16px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; margin-top: 8px;
    }
    button:hover { opacity: 0.9; }
    button:disabled { opacity: 0.3; cursor: not-allowed; }
    
    .loading { font-style: italic; opacity: 0.5; }
  </style>
</head>
<body>

  <div class="card">
    <h1>Japan Random Sampler</h1>
    
    <div id="display" class="loading">Initializing geographical data...</div>

    <button id="btn" disabled>Loading...</button>

    <div id="coords-box" class="coords" style="display:none;">
      <span id="latlon">0.0000, 0.0000</span>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/earcut/2.2.4/earcut.min.js"></script>

  <script>
    let triangles = [];
    let totalArea = 0;
    let cityData = [];

    const btn = document.getElementById('btn');
    const display = document.getElementById('display');
    const coordsBox = document.getElementById('coords-box');
    const latlon = document.getElementById('latlon');

    async function init() {
      try {
        const [jpRes, muniRes] = await Promise.all([
          fetch('jp.json'),
          fetch('municipalities.json')
        ]);
        
        const jpData = await jpRes.json();
        cityData = await muniRes.json();

        // Prepare Area-Weighted Triangles
        jpData.features.forEach(f => {
          const polygons = f.geometry.type === "MultiPolygon" ? f.geometry.coordinates : [f.geometry.coordinates];
          polygons.forEach(ringSet => {
            const data = earcut.flatten(ringSet);
            const indices = earcut(data.vertices, data.holes, data.dimensions);
            for (let i = 0; i < indices.length; i += 3) {
              const a = [data.vertices[indices[i]*2], data.vertices[indices[i]*2+1]];
              const b = [data.vertices[indices[i+1]*2], data.vertices[indices[i+1]*2+1]];
              const c = [data.vertices[indices[i+2]*2], data.vertices[indices[i+2]*2+1]];
              const area = Math.abs((a[0]*(b[1]-c[1]) + b[0]*(c[1]-a[1]) + c[0]*(a[1]-b[1])) / 2);
              triangles.push({a, b, c, area});
              totalArea += area;
            }
          });
        });

        display.innerHTML = "Ready to sample.";
        btn.disabled = false;
        btn.textContent = "SAMPLE LAND";
        roll();
      } catch (err) {
        display.textContent = "Error: " + err.message;
        console.error(err);
      }
    }

    function roll() {
      // 1. Sample a point based on area weight
      let r = Math.random() * totalArea;
      let tri;
      for (const t of triangles) {
        r -= t.area;
        if (r <= 0) { tri = t; break; }
      }
      const r1 = Math.sqrt(Math.random());
      const r2 = Math.random();
      const pt = {
        lon: (1 - r1) * tri.a[0] + (r1 * (1 - r2)) * tri.b[0] + (r1 * r2) * tri.c[0],
        lat: (1 - r1) * tri.a[1] + (r1 * (1 - r2)) * tri.b[1] + (r1 * r2) * tri.c[1]
      };

      // 2. Find nearest City (Shi/Ku) and Town/Village (Machi/Mura)
      let nearestCity = null, dCity = Infinity;
      let nearestTown = null, dTown = Infinity;

      for (const c of cityData) {
        const d = Math.pow(parseFloat(c.lat) - pt.lat, 2) + Math.pow(parseFloat(c.lon) - pt.lon, 2);
        const name = c.name_romaji || "";
        const isCity = name.endsWith("Shi") || name.endsWith("Ku");

        if (isCity) {
          if (d < dCity) { dCity = d; nearestCity = c; }
        } else {
          if (d < dTown) { dTown = d; nearestTown = c; }
        }
      }

      // 3. Render
      display.innerHTML = `
        <div class="label">Nearest City</div>
        <div class="value">${nearestCity.name_kanji}<div class="sub-value">${nearestCity.name_romaji}, ${nearestCity.prefecture_romaji}</div></div>
        
        <div class="label">Nearest Town / Village</div>
        <div class="value">${nearestTown.name_kanji}<div class="sub-value">${nearestTown.name_romaji}, ${nearestTown.prefecture_romaji}</div></div>
      `;
      
      coordsBox.style.display = "block";
      latlon.textContent = `${pt.lat.toFixed(6)}, ${pt.lon.toFixed(6)}`;
    }

    btn.addEventListener('click', roll);
    window.addEventListener('keydown', (e) => { if(e.key === 'r' || e.key === ' ') roll(); });
    init();
  </script>
</body>
</html>