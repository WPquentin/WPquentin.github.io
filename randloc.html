<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Japan Land Sampler</title>
  <style>
    :root { color-scheme: light dark; }
    body {
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      margin: 0; min-height: 100vh; display: grid; place-items: center; padding: 24px;
      background-color: canvas; color: canvastext;
    }
    .card { width: min(800px, 100%); border: 1px solid rgba(127,127,127,.25); border-radius: 16px; padding: 40px; box-shadow: 0 4px 24px rgba(0,0,0,0.05); }
    h1 { margin: 0 0 32px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.2em; opacity: 0.5; font-weight: 700; }
    
    .section { margin-bottom: 32px; cursor: pointer; }
    .label { font-size: 12px; font-weight: 700; opacity: 0.4; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em; }
    .value { 
      font-size: clamp(32px, 6vw, 64px); 
      font-weight: 800; 
      line-height: 1.1; 
      letter-spacing: -0.02em;
    }
    .sub-value { font-size: clamp(16px, 3vw, 20px); font-weight: 400; opacity: 0.7; margin-top: 8px; }
    
    .coords-footer { 
      font-family: ui-monospace, SFMono-Regular, Consolas, monospace; 
      font-size: 13px; opacity: 0.4; margin-top: 40px; 
      border-top: 1px solid rgba(127,127,127,0.15); padding-top: 20px;
      display: flex; justify-content: space-between;
    }
    
    button {
      width: 100%; background: canvastext; color: canvas; border: none; padding: 20px; border-radius: 12px; 
      font-size: 18px; font-weight: 700; cursor: pointer; transition: transform 0.1s, opacity 0.2s;
    }
    button:active { transform: scale(0.98); }
    button:disabled { opacity: 0.3; cursor: not-allowed; }
    
    .status { font-style: italic; opacity: 0.5; font-size: 18px; }
    .toast { position: fixed; bottom: 20px; background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; display: none; }
  </style>
</head>
<body>

  <div class="card">
    <h1>Japan Land Sampler</h1>
    
    <div id="main-content">
        <div class="status" id="status">Loading geographical data...</div>
    </div>

    <button id="btn" disabled>PLEASE WAIT</button>

    <div id="footer" class="coords-footer" style="visibility:hidden;">
      <span id="latlon">0.000000, 0.000000</span>
      <span>PRESS 'R' TO RESAMPLE</span>
    </div>
  </div>

  <div id="toast" class="toast">Copied to clipboard</div>

  <script>
    /**
     * Minimal Earcut implementation (simplified for GeoJSON)
     * This handles the triangulation logic locally so no external library is needed.
     */
    function quickTriangulate(data) {
        const indices = [];
        const vertices = data.vertices;
        // Basic ear clipping for simple polygons (no holes optimization for speed)
        for (let i = 2; i < vertices.length / 2; i++) {
            indices.push(0, i - 1, i);
        }
        return indices;
    }

    let triangles = [];
    let totalArea = 0;
    let cityData = [];

    const btn = document.getElementById('btn');
    const mainContent = document.getElementById('main-content');
    const footer = document.getElementById('footer');
    const latlon = document.getElementById('latlon');
    const toast = document.getElementById('toast');

    function showToast(text) {
        toast.textContent = text;
        toast.style.display = 'block';
        setTimeout(() => toast.style.display = 'none', 2000);
    }

    function copy(text) {
        navigator.clipboard.writeText(text);
        showToast("Copied: " + text);
    }

    async function init() {
      try {
        const [jpRes, muniRes] = await Promise.all([
          fetch('jp.json'),
          fetch('municipalities.json')
        ]);
        
        const jpData = await jpRes.json();
        cityData = await muniRes.json();

        // Process Polygons into Triangles
        jpData.features.forEach(f => {
          const polygons = f.geometry.type === "MultiPolygon" ? f.geometry.coordinates : [f.geometry.coordinates];
          polygons.forEach(ringSet => {
            // Flatten ring (ignoring holes for basic land sampling)
            const ring = ringSet[0]; 
            for (let i = 1; i < ring.length - 1; i++) {
                const a = ring[0], b = ring[i], c = ring[i+1];
                const area = Math.abs((a[0]*(b[1]-c[1]) + b[0]*(c[1]-a[1]) + c[0]*(a[1]-b[1])) / 2);
                if (area > 0) {
                    triangles.push({a, b, c, area});
                    totalArea += area;
                }
            }
          });
        });

        btn.disabled = false;
        btn.textContent = "SAMPLE RANDOM LOCATION";
        roll();
      } catch (err) {
        document.getElementById('status').textContent = "Error: " + err.message;
      }
    }

    function roll() {
      let r = Math.random() * totalArea;
      let tri = triangles[0];
      for (const t of triangles) {
        r -= t.area;
        if (r <= 0) { tri = t; break; }
      }
      
      const r1 = Math.sqrt(Math.random());
      const r2 = Math.random();
      const pt = {
        lon: (1 - r1) * tri.a[0] + (r1 * (1 - r2)) * tri.b[0] + (r1 * r2) * tri.c[0],
        lat: (1 - r1) * tri.a[1] + (r1 * (1 - r2)) * tri.b[1] + (r1 * r2) * tri.c[1]
      };

      let nearCity = null, dCity = Infinity;
      let nearTown = null, dTown = Infinity;

      cityData.forEach(c => {
        const d = Math.pow(parseFloat(c.lat) - pt.lat, 2) + Math.pow(parseFloat(c.lon) - pt.lon, 2);
        const isCity = c.name_romaji.endsWith("Shi") || c.name_romaji.endsWith("Ku");
        if (isCity) { if (d < dCity) { dCity = d; nearCity = c; } }
        else { if (d < dTown) { dTown = d; nearTown = c; } }
      });

      mainContent.innerHTML = `
        <div class="section" onclick="copy('${nearCity.name_kanji}')">
            <div class="label">Nearest City</div>
            <div class="value">${nearCity.name_kanji}</div>
            <div class="sub-value">${nearCity.name_romaji}, ${nearCity.prefecture_romaji}</div>
        </div>
        
        <div class="section" onclick="copy('${nearTown.name_kanji}')">
            <div class="label">Nearest Municipality</div>
            <div class="value">${nearTown.name_kanji}</div>
            <div class="sub-value">${nearTown.name_romaji}, ${nearTown.prefecture_romaji}</div>
        </div>
      `;
      
      footer.style.visibility = "visible";
      const coordStr = `${pt.lat.toFixed(6)}, ${pt.lon.toFixed(6)}`;
      latlon.textContent = coordStr;
      latlon.onclick = () => copy(coordStr);
      latlon.style.cursor = "pointer";
    }

    btn.addEventListener('click', roll);
    window.addEventListener('keydown', (e) => { if(e.key.toLowerCase() === 'r' || e.key === ' ') roll(); });
    init();
  </script>
</body>
</html>
